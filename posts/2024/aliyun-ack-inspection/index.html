<!doctype html><html lang=en><head><title>Aliyun ACK巡检功能复现 :: en1r0py</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="背景 通过Aliyun ACK提供的巡检检查功能进行检查，下列整理安全相关的检查项复现方式以及安全隐患。 "><meta name=keywords content="aliyun,cloud-security"><meta name=robots content="noodp"><link rel=canonical href=/posts/2024/aliyun-ack-inspection/><link rel=stylesheet href=/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css><link rel=stylesheet href=/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css><link rel=stylesheet href=/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css><link rel=stylesheet href=/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css><link rel=stylesheet href=/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css><link rel=stylesheet href=/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css><link rel=stylesheet href=/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css><link rel=stylesheet href=/css/terminal.min.4b367d85d0d0061435650561285afed36c46a7cf8dc6d7ed5642d98e589fa622.css><link rel=stylesheet href=/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=/favicon.png><link rel=apple-touch-icon href=/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Aliyun ACK巡检功能复现"><meta property="og:description" content="背景 通过Aliyun ACK提供的巡检检查功能进行检查，下列整理安全相关的检查项复现方式以及安全隐患。 "><meta property="og:url" content="/posts/2024/aliyun-ack-inspection/"><meta property="og:site_name" content="en1r0py"><meta property="og:image" content="/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-11-09 11:55:55 +0800 +0800"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://en1r0py1865.github.io/><div class=logo>en1r0py1865</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li><li><a href=/portswigger>Portswigger Academy</a></li><li><a href=/>Post</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li><li><a href=/portswigger>Portswigger Academy</a></li><li><a href=/>Post</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/posts/2024/aliyun-ack-inspection/>Aliyun ACK巡检功能复现</a></h1><div class=post-meta><time class=post-date>2024-11-09</time></div><span class=post-tags>#<a href=/tags/aliyun/>aliyun</a>&nbsp;
#<a href=/tags/cloud-security/>cloud-security</a>&nbsp;</span><div class=post-content><div><h2 id=背景>背景<a href=#背景 class=hanchor arialabel=Anchor>#</a></h2><ul><li>通过Aliyun ACK提供的<a href=https://www.alibabacloud.com/help/zh/ack/ack-managed-and-ack-dedicated/security-and-compliance/use-the-inspection-feature-to-detect-security-risks-in-the-workloads-of-an-ack-cluster>巡检检查功能</a>进行检查，下列整理安全相关的检查项复现方式以及安全隐患。</li></ul><h2 id=ack集群信息>ACK集群信息<a href=#ack集群信息 class=hanchor arialabel=Anchor>#</a></h2><ul><li>集群规格: 基础版</li><li>Kubernetes 1.31.1-aliyun.1</li><li>容器运行时: containerd 1.6.34</li><li>实例规格: ecs.c5.xlarge(4c/8g)</li><li>操作系统: Alibaba Cloud Linux 3.2104 LTS 64位</li><li>网络插件: Flannel</li><li>安全加固: 阿里云OS加固</li><li>期望节点数: 3</li></ul><h2 id=禁止以特权模式启动容器runasprivileged>禁止以特权模式启动容器(runAsPrivileged)<a href=#禁止以特权模式启动容器runasprivileged class=hanchor arialabel=Anchor>#</a></h2><h3 id=复现yaml>复现yaml<a href=#复现yaml class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h3 id=危害>危害<a href=#危害 class=hanchor arialabel=Anchor>#</a></h3><ul><li>直接挂载宿主机目录后，对宿主机文件进行读写。</li></ul><h3 id=缓解>缓解<a href=#缓解 class=hanchor arialabel=Anchor>#</a></h3><ul><li>避免使用root用户运行容器。</li></ul><h3 id=利用步骤>利用步骤<a href=#利用步骤 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl exec -it inspector-deployment-&lt;pod id&gt; -- bash</span>
</span></span><span style=display:flex><span><span style=color:#75715e># yum install -y util-linux</span>
</span></span><span style=display:flex><span><span style=color:#75715e># fdisk -l</span>
</span></span><span style=display:flex><span>Disk /dev/vda: <span style=color:#ae81ff>30</span> GiB, <span style=color:#ae81ff>32212254720</span> bytes, <span style=color:#ae81ff>62914560</span> sectors
</span></span><span style=display:flex><span>Units: sectors of <span style=color:#ae81ff>1</span> * 512 <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>Sector size <span style=color:#f92672>(</span>logical/physical<span style=color:#f92672>)</span>: <span style=color:#ae81ff>512</span> bytes / <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>I/O size <span style=color:#f92672>(</span>minimum/optimal<span style=color:#f92672>)</span>: <span style=color:#ae81ff>512</span> bytes / <span style=color:#ae81ff>512</span> bytes
</span></span><span style=display:flex><span>Disklabel type: gpt
</span></span><span style=display:flex><span>Disk identifier: 0F2F0AED-A1BF-46F2-AEC4-E8727122801F
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Device      Start      End  Sectors  Size Type
</span></span><span style=display:flex><span>/dev/vda1    <span style=color:#ae81ff>2048</span>     <span style=color:#ae81ff>6143</span>     <span style=color:#ae81ff>4096</span>    2M BIOS boot
</span></span><span style=display:flex><span>/dev/vda2    <span style=color:#ae81ff>6144</span>   <span style=color:#ae81ff>415743</span>   <span style=color:#ae81ff>409600</span>  200M EFI System
</span></span><span style=display:flex><span>/dev/vda3  <span style=color:#ae81ff>415744</span> <span style=color:#ae81ff>62914526</span> <span style=color:#ae81ff>62498783</span> 29.8G Linux filesystem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># mkdir /host</span>
</span></span><span style=display:flex><span><span style=color:#75715e># mount /dev/vda3 /host</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ls /host</span>
</span></span><span style=display:flex><span>bin  boot  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
</span></span></code></pre></div><h3 id=修复yaml>修复yaml<a href=#修复yaml class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]
</span></span></code></pre></div><h2 id=禁止以-root-用户启动容器runasrootallowed>禁止以 root 用户启动容器(runAsRootAllowed)<a href=#禁止以-root-用户启动容器runasrootallowed class=hanchor arialabel=Anchor>#</a></h2><h3 id=复现yaml-1>复现yaml<a href=#复现yaml-1 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]
</span></span></code></pre></div><h3 id=配置项说明>配置项说明<a href=#配置项说明 class=hanchor arialabel=Anchor>#</a></h3><ul><li>强制禁止以root用户启动容器，若yaml没有配置runAsUser参数且镜像默认以 root 用户运行则会报错<code>container has runAsNonRoot and image will run as root</code>。</li></ul><h3 id=危害-1>危害<a href=#危害-1 class=hanchor arialabel=Anchor>#</a></h3><ul><li>当yaml中没有此项宣告时，且容器使用root权限启动时才有危害，其危害等于是使用root运行容器的危害。</li></ul><h3 id=修复yaml-1>修复yaml<a href=#修复yaml-1 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsNonRoot</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsGroup</span>: <span style=color:#ae81ff>505</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>505</span>  
</span></span></code></pre></div><h2 id=禁止容器内子进程拥有提升权限的能力privilegeescalationallowed>禁止容器内子进程拥有提升权限的能力(privilegeEscalationAllowed)<a href=#禁止容器内子进程拥有提升权限的能力privilegeescalationallowed class=hanchor arialabel=Anchor>#</a></h2><h3 id=复现yaml-2>复现yaml<a href=#复现yaml-2 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sudo yum install -y tar &amp;&amp; while true; do sleep 30; done;&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsNonRoot</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsGroup</span>: <span style=color:#ae81ff>505</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>505</span>  
</span></span></code></pre></div><h3 id=利用步骤-1>利用步骤<a href=#利用步骤-1 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># yum install -y gcc</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; setuid.c
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#include &lt;stdio.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#include &lt;stdlib.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#include &lt;unistd.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>int main() {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    setuid(0);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    system(&#34;/bin/bash&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># gcc -o setuid setuid.c</span>
</span></span><span style=display:flex><span><span style=color:#75715e># chmod u+s setuid</span>
</span></span><span style=display:flex><span><span style=color:#75715e># kubectl cp setuid inspector-deployment-&lt;pod id&gt;:/tmp/setuid</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># kubectl exec -it inspector-deployment-&lt;pod id&gt; -- bash</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cd /tmp</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ./setuid </span>
</span></span><span style=display:flex><span>sh: /bin/bash: Operation not permitted
</span></span><span style=display:flex><span>Killed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 触发阿里云(企业版)告警: 反弹shell(精准防御)</span>
</span></span><span style=display:flex><span>- 父进程关系
</span></span><span style=display:flex><span>  - <span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>/usr/lib/systemd/systemd --switched-root --system --deserialize <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>[</span>76229<span style=color:#f92672>]</span>/usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 58a1015c031108da981ab773045901b1a8c48c7cb51a08056731d451ac92e96e -address /run/containerd/containerd.sock
</span></span><span style=display:flex><span>      - <span style=color:#f92672>[</span>76692<span style=color:#f92672>]</span>bash
</span></span><span style=display:flex><span>        - <span style=color:#f92672>[</span>76743<span style=color:#f92672>]</span>./setuid
</span></span></code></pre></div><h3 id=golang代码也会触发阿里云企业版告警-反弹shell精准防御>golang代码也会触发阿里云(企业版)告警: 反弹shell(精准防御)<a href=#golang代码也会触发阿里云企业版告警-反弹shell精准防御 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os/exec&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;syscall&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提升进程权限
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Setuid</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Failed to set UID:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动 Bash shell
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;/bin/bash&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Stdin</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdin</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Stdout</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Stderr</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Failed to start Bash shell:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=配置项说明-1>配置项说明<a href=#配置项说明-1 class=hanchor arialabel=Anchor>#</a></h3><ul><li>此参数可以避免容器因为配置错误或漏洞导致的非root用户提权。<ul><li>禁止sudo操作，会得到报错<code>sudo: effective uid is not 0, is /usr/bin/sudo on a file system with the 'nosuid' option set or an NFS file system without root privileges?</code></li><li>避免setuid 和 setgid等文件导致的提权。<ul><li>当执行带有setuid/setgid命令的程序时，程序可以要求操作系统给予进程所有者(或组)的权限。</li></ul></li></ul></li></ul><h3 id=危害-2>危害<a href=#危害-2 class=hanchor arialabel=Anchor>#</a></h3><ul><li>非root用户提权；换言之，若容器内有错误配置或漏洞导致攻击者从普通用户提权到root时， 才可能造成危害。</li><li>ATT&amp;CK T1548-001-linux-Setuid and Setgid。</li></ul><h3 id=修复yaml-2>修复yaml<a href=#修复yaml-2 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsNonRoot</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsGroup</span>: <span style=color:#ae81ff>505</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>505</span>  
</span></span><span style=display:flex><span>          <span style=color:#f92672>allowPrivilegeEscalation</span>: <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><h2 id=禁止容器共享主机的网络命名空间hostnetworkset>禁止容器共享主机的网络命名空间(hostNetworkSet)<a href=#禁止容器共享主机的网络命名空间hostnetworkset class=hanchor arialabel=Anchor>#</a></h2><h3 id=复现yaml-3>复现yaml<a href=#复现yaml-3 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>hostNetwork</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]          
</span></span></code></pre></div><h3 id=配置说明>配置说明<a href=#配置说明 class=hanchor arialabel=Anchor>#</a></h3><ul><li>使 Pod 使用宿主机的网络命名空间。这意味着 Pod 内的容器将共享宿主机的网络接口和 IP 地址。</li></ul><h3 id=危害-3>危害<a href=#危害-3 class=hanchor arialabel=Anchor>#</a></h3><ul><li>与宿主机使用相同网络命名空间，可以使用netstat、ifconfig列出网络信息(与宿主机返回结果相同)，并且监听端口与宿主机互斥。</li><li>可以使用工具(tcpdump)监听宿主机流量。</li></ul><h3 id=利用步骤-2>利用步骤<a href=#利用步骤-2 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># yum install -y net-tools</span>
</span></span><span style=display:flex><span><span style=color:#75715e># yum install -y nc</span>
</span></span><span style=display:flex><span><span style=color:#75715e># nc -l 4444</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># kubectl exec -it inspector-deployment-&lt;pod id&gt; -- bash</span>
</span></span><span style=display:flex><span><span style=color:#75715e># yum install -y tcpdump</span>
</span></span><span style=display:flex><span><span style=color:#75715e># tcpdump -i any tcp port 4444 -X</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 在另一台机器上操作，并随机输入数据</span>
</span></span><span style=display:flex><span><span style=color:#75715e># nc &lt;ip&gt; 4444</span>
</span></span></code></pre></div><h2 id=禁止容器共享主机的ipc命名空间hostipcset>禁止容器共享主机的IPC命名空间(hostIPCSet)<a href=#禁止容器共享主机的ipc命名空间hostipcset class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>hostIPC</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]       
</span></span></code></pre></div><h3 id=配置说明-1>配置说明<a href=#配置说明-1 class=hanchor arialabel=Anchor>#</a></h3><ul><li>IPC(POSIX/SysV IPC)命名空间提供了命名共享内存段、信号量和消息队列的隔离；此参数将宿主机的 IPC 命名空间与容器共享。</li></ul><h3 id=危害-4>危害<a href=#危害-4 class=hanchor arialabel=Anchor>#</a></h3><ul><li>允许容器内的进程查看主机系统上的所有 IPC 通信，可能造成敏感数据泄露或非预期的进程行为。</li></ul><h3 id=利用步骤-3>利用步骤<a href=#利用步骤-3 class=hanchor arialabel=Anchor>#</a></h3><p>使用ipcs命令查看宿主机的IPC命名空间</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl exec -it inspector-deployment-&lt;pod id&gt; -- bash</span>
</span></span><span style=display:flex><span><span style=color:#75715e># yum install -y util-linux</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ipcs -m</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ipcs -q</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ipcs -s</span>
</span></span></code></pre></div><p>使用python进行利用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 解决 ModuleNotFoundError: No module named &#39;sysv_ipc&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo yum install -y wget tar gcc python3-devel util-linux</span>
</span></span><span style=display:flex><span><span style=color:#75715e># pip3 install --upgrade pip setuptools</span>
</span></span><span style=display:flex><span><span style=color:#75715e># pip3 install sysv_ipc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用源代码安装sysv_ipc</span>
</span></span><span style=display:flex><span><span style=color:#75715e># wget https://files.pythonhosted.org/packages/source/s/sysv_ipc/sysv_ipc-1.0.1.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#75715e># tar xzf sysv_ipc-1.0.1.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cd sysv_ipc-1.0.1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># python3 setup.py install</span>
</span></span></code></pre></div><p>宿主机代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sysv_ipc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建共享内存段</span>
</span></span><span style=display:flex><span>key <span style=color:#f92672>=</span> <span style=color:#ae81ff>12345</span>
</span></span><span style=display:flex><span>memory <span style=color:#f92672>=</span> sysv_ipc<span style=color:#f92672>.</span>SharedMemory(key, sysv_ipc<span style=color:#f92672>.</span>IPC_CREAT, size<span style=color:#f92672>=</span><span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 写入数据</span>
</span></span><span style=display:flex><span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello from the host!&#34;</span>
</span></span><span style=display:flex><span>memory<span style=color:#f92672>.</span>write(message<span style=color:#f92672>.</span>encode())
</span></span></code></pre></div><p>容器代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sysv_ipc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 连接到共享内存段</span>
</span></span><span style=display:flex><span>key <span style=color:#f92672>=</span> <span style=color:#ae81ff>12345</span>
</span></span><span style=display:flex><span>memory <span style=color:#f92672>=</span> sysv_ipc<span style=color:#f92672>.</span>SharedMemory(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 读取数据</span>
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> memory<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;从共享内存段读取的数据:&#34;</span>, data<span style=color:#f92672>.</span>decode()<span style=color:#f92672>.</span>strip())
</span></span></code></pre></div><h2 id=禁止容器共享主机的pid命名空间hostpidset>禁止容器共享主机的PID命名空间(hostPIDSet)<a href=#禁止容器共享主机的pid命名空间hostpidset class=hanchor arialabel=Anchor>#</a></h2><h3 id=复现yaml-4>复现yaml<a href=#复现yaml-4 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>hostPID</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alibaba-cloud-linux-3-registry.cn-hangzhou.cr.aliyuncs.com/alinux3/alinux3:x86-3.220822.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;while true; do sleep 30; done;&#34;</span>]                      
</span></span></code></pre></div><h3 id=配置说明-2>配置说明<a href=#配置说明-2 class=hanchor arialabel=Anchor>#</a></h3><ul><li>宿主机的 PID 命名空间与容器共享，这将允许容器内的进程查看宿主机系统上的所有进程。</li></ul><h3 id=危害-5>危害<a href=#危害-5 class=hanchor arialabel=Anchor>#</a></h3><ul><li>容器内的进程或用户可以访问宿主机上的进程，读取其信息或结束进程。</li></ul><h3 id=缓解-1>缓解<a href=#缓解-1 class=hanchor arialabel=Anchor>#</a></h3><ul><li>非root容器用户可以适当缓解。</li></ul><h3 id=利用步骤-4>利用步骤<a href=#利用步骤-4 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl exec -it inspector-deployment-&lt;pod id&gt; -- bash</span>
</span></span><span style=display:flex><span><span style=color:#75715e># yum install -y procps</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ps aux</span>
</span></span><span style=display:flex><span><span style=color:#75715e># kill -9 &lt;目标pid&gt;</span>
</span></span></code></pre></div><h2 id=禁止容器内进程监听节点主机端口hostportset>禁止容器内进程监听节点主机端口(hostPortSet)<a href=#禁止容器内进程监听节点主机端口hostportset class=hanchor arialabel=Anchor>#</a></h2><h3 id=复现yaml-5>复现yaml<a href=#复现yaml-5 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>inspector-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>inspector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>anolis-registry.cn-zhangjiakou.cr.aliyuncs.com/openanolis/nginx:1.14.1-8.6</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>hostPort</span>: <span style=color:#ae81ff>8081</span>
</span></span></code></pre></div><h3 id=配置说明-3>配置说明<a href=#配置说明-3 class=hanchor arialabel=Anchor>#</a></h3><ul><li>在支持hostPort的CNI插件(例如Flannel)上部署，则可以直接使用宿主机ip:port进行访问。</li><li>宿主机使用netstat命令返回中不会出现contianer通过hostPort监听端口的信息。</li></ul><h3 id=危害-6>危害<a href=#危害-6 class=hanchor arialabel=Anchor>#</a></h3><ul><li>可能造成容器内进程挤占宿主机可用端口，造成端口冲突进而导致 Pod 无法被调度的风险。</li></ul><h3 id=利用步骤-5>利用步骤<a href=#利用步骤-5 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># wget &lt;pod分配到的宿主机ip&gt;:8081</span>
</span></span></code></pre></div></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>